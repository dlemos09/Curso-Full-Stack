================================================================================
                    LISTA DE EXERC√çCIOS - BANCO DE DADOS POSTGRESQL
                           Curso Intensivo - 15 Dias (60h)
================================================================================

COMO USAR ESTE ARQUIVO:
- Este documento cont√©m APENAS os enunciados dos exerc√≠cios
- Consulte o arquivo "gabarito_bd_postgres.txt" para respostas completas
- Execute o arquivo "scripts.sql" para criar as estruturas necess√°rias
- Importe os arquivos CSV conforme orienta√ß√µes no plano de aula
- Assuma PostgreSQL 14+ e DBeaver como ambiente de desenvolvimento

LEGENDA:
üü¢ F√°cil      | ‚è±Ô∏è Tempo estimado | üìä Tabelas utilizadas

================================================================================
                              SUM√ÅRIO POR T√ìPICO
================================================================================
1. Conceitos B√°sicos e DDL (Exerc√≠cios 1-8)
2. Manipula√ß√£o de Dados - DML (Exerc√≠cios 9-14)
3. Consultas Simples e Filtros (Exerc√≠cios 15-20)
4. Jun√ß√µes e Relacionamentos (Exerc√≠cios 21-26)
5. Fun√ß√µes Agregadas e Agrupamento (Exerc√≠cios 27-32)
6. Subconsultas e Consultas Avan√ßadas (Exerc√≠cios 33-38)
7. Views e Performance (Exerc√≠cios 39-43)
8. Fun√ß√µes, Procedures e Triggers (Exerc√≠cios 44-48)
9. Administra√ß√£o e Otimiza√ß√£o (Exerc√≠cios 49-52)
10. Projetos Integrados (Exerc√≠cios 53-55)

================================================================================
                    SE√á√ÉO 1: CONCEITOS B√ÅSICOS E DDL
================================================================================

EXERC√çCIO 1 - Cria√ß√£o de Database e Schema
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 10 minutos | üìä Nenhuma tabela pr√©via

Crie um banco de dados chamado "loja_virtual" e dentro dele crie dois schemas:
- "vendas" para armazenar dados de produtos, pedidos e clientes
- "estoque" para armazenar informa√ß√µes de invent√°rio e fornecedores

--------------------------------------------------------------------------------

EXERC√çCIO 2 - Cria√ß√£o de Tabelas com Constraints B√°sicas
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Schema: vendas

No schema "vendas", crie a tabela "clientes" com as seguintes colunas:
- id_cliente (inteiro, chave prim√°ria, auto-incremento)
- nome (texto at√© 100 caracteres, obrigat√≥rio)
- email (texto at√© 150 caracteres, √∫nico, obrigat√≥rio)
- cpf (texto 11 caracteres, √∫nico)
- data_nascimento (data)
- data_cadastro (timestamp, padr√£o: data/hora atual)
- ativo (booleano, padr√£o: true)

Adicione uma constraint CHECK para garantir que a data de nascimento seja 
anterior a 18 anos atr√°s (cliente maior de idade).

--------------------------------------------------------------------------------

EXERC√çCIO 3 - Relacionamentos com Chaves Estrangeiras
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Schema: vendas

Crie as seguintes tabelas no schema "vendas":

a) Tabela "categorias":
   - id_categoria (inteiro, PK, auto-incremento)
   - nome (texto 50 caracteres, √∫nico, obrigat√≥rio)
   - descricao (texto 200 caracteres)

b) Tabela "produtos":
   - id_produto (inteiro, PK, auto-incremento)
   - nome (texto 100 caracteres, obrigat√≥rio)
   - descricao (texto)
   - preco (decimal 10,2, obrigat√≥rio)
   - id_categoria (inteiro, FK para categorias)
   - estoque_minimo (inteiro, padr√£o: 0)
   - ativo (booleano, padr√£o: true)

Configure a FK para que, ao deletar uma categoria, os produtos relacionados 
tenham id_categoria definido como NULL (ON DELETE SET NULL).

--------------------------------------------------------------------------------

EXERC√çCIO 4 - Tipos de Dados do PostgreSQL
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Schema: estoque

Crie a tabela "fornecedores" no schema "estoque" utilizando diversos tipos de 
dados do PostgreSQL:
- id_fornecedor (SERIAL, PK)
- razao_social (VARCHAR(200), obrigat√≥rio)
- cnpj (CHAR(14), √∫nico)
- contato (JSONB - armazenar telefone, email, website)
- endereco_completo (TEXT)
- coordenadas (POINT - latitude/longitude)
- horario_atendimento (TSRANGE - intervalo de timestamps)
- avaliacoes (INTEGER[] - array de notas de 1 a 5)
- ativo (BOOLEAN, padr√£o true)

--------------------------------------------------------------------------------

EXERC√çCIO 5 - Altera√ß√£o de Estrutura de Tabelas
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: clientes, produtos

Realize as seguintes altera√ß√µes:

a) Na tabela "clientes":
   - Adicione a coluna "telefone" (VARCHAR 20)
   - Adicione a coluna "limite_credito" (DECIMAL 10,2 com padr√£o 1000.00)
   - Renomeie a coluna "ativo" para "status_ativo"

b) Na tabela "produtos":
   - Adicione uma constraint CHECK para garantir que preco > 0
   - Adicione uma constraint CHECK para garantir estoque_minimo >= 0
   - Modifique a coluna "descricao" para ser obrigat√≥ria

--------------------------------------------------------------------------------

EXERC√çCIO 6 - Cria√ß√£o de Tabela de Relacionamento N:N
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Schema: vendas

Crie a estrutura para gerenciar pedidos:

a) Tabela "pedidos":
   - id_pedido (SERIAL, PK)
   - id_cliente (INTEGER, FK para clientes, obrigat√≥rio)
   - data_pedido (TIMESTAMP, padr√£o: agora)
   - status (VARCHAR 20, CHECK: 'pendente', 'processando', 'enviado', 'entregue', 'cancelado')
   - valor_total (DECIMAL 10,2, padr√£o: 0)
   - observacoes (TEXT)

b) Tabela "itens_pedido" (relacionamento N:N entre pedidos e produtos):
   - id_item (SERIAL, PK)
   - id_pedido (INTEGER, FK para pedidos, ON DELETE CASCADE)
   - id_produto (INTEGER, FK para produtos, ON DELETE RESTRICT)
   - quantidade (INTEGER, obrigat√≥rio, CHECK > 0)
   - preco_unitario (DECIMAL 10,2, obrigat√≥rio)
   - desconto (DECIMAL 5,2, padr√£o: 0, CHECK entre 0 e 100)

--------------------------------------------------------------------------------

EXERC√çCIO 7 - √çndices e Primary Keys Compostas
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Schema: estoque

Crie a tabela "movimentacoes_estoque" com:
- id_movimentacao (SERIAL, parte da PK)
- data_movimentacao (TIMESTAMP, parte da PK)
- id_produto (INTEGER, FK para vendas.produtos)
- tipo_movimentacao (CHAR 1: 'E'=entrada, 'S'=sa√≠da)
- quantidade (INTEGER, obrigat√≥rio)
- id_fornecedor (INTEGER, FK para fornecedores, pode ser NULL)
- custo_unitario (DECIMAL 10,2)
- observacao (TEXT)

Configure:
- Primary Key composta: (id_movimentacao, data_movimentacao)
- √çndice em (id_produto, data_movimentacao) para consultas r√°pidas
- √çndice em (tipo_movimentacao, data_movimentacao)
- Constraint CHECK: se tipo='E' ent√£o id_fornecedor NOT NULL

--------------------------------------------------------------------------------

EXERC√çCIO 8 - DROP, TRUNCATE e Gest√£o de Constraints
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 15 minutos | üìä V√°rias tabelas

Execute as seguintes opera√ß√µes:

a) Crie uma tabela tempor√°ria "temp_importacao" com colunas livres
b) Insira 5 registros fict√≠cios nela
c) Use TRUNCATE para limpar os dados (mantendo estrutura)
d) Use DROP para remover a tabela completamente
e) Na tabela "produtos", remova a constraint de CHECK do pre√ßo
f) Adicione novamente uma constraint CHECK mais rigorosa: preco BETWEEN 0.01 AND 999999.99
g) Liste todas as constraints da tabela "produtos" usando consulta ao cat√°logo do sistema

================================================================================
                    SE√á√ÉO 2: MANIPULA√á√ÉO DE DADOS - DML
================================================================================

EXERC√çCIO 9 - Inser√ß√£o B√°sica de Dados
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 10 minutos | üìä Tabelas: categorias, clientes

Insira dados nas seguintes tabelas:

a) Insira 5 categorias diferentes (eletr√¥nicos, livros, roupas, alimentos, m√≥veis)

b) Insira 8 clientes com dados completos, incluindo:
   - Pelo menos 2 clientes menores de 30 anos
   - Pelo menos 2 clientes maiores de 50 anos
   - Emails √∫nicos e v√°lidos
   - CPFs fict√≠cios mas √∫nicos

Use INSERT com m√∫ltiplas linhas em um √∫nico comando.

--------------------------------------------------------------------------------

EXERC√çCIO 10 - Inser√ß√£o com Subconsultas e RETURNING
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, fornecedores

a) Insira 3 fornecedores com dados JSONB para contato:
   {
     "telefone": "(11) 98888-9999",
     "email": "contato@fornecedor.com",
     "website": "www.fornecedor.com.br"
   }

b) Insira 15 produtos de diferentes categorias usando RETURNING para capturar 
   os IDs gerados. Varie os pre√ßos entre R$ 10,00 e R$ 5.000,00.

c) Mostre como usar INSERT INTO ... SELECT para copiar produtos de uma categoria 
   para criar produtos similares em outra categoria (com nomes modificados).

--------------------------------------------------------------------------------

EXERC√çCIO 11 - Atualiza√ß√£o de Dados com WHERE
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 10 minutos | üìä Tabelas: produtos, clientes

Execute as seguintes atualiza√ß√µes:

a) Aumente em 10% o pre√ßo de todos os produtos da categoria "eletr√¥nicos"
b) Aplique 15% de desconto nos produtos com estoque_minimo > 50
c) Atualize o limite de cr√©dito para R$ 5.000,00 dos clientes cadastrados h√° 
   mais de 1 ano
d) Marque como inativo (status_ativo = false) os clientes que nunca fizeram pedido

--------------------------------------------------------------------------------

EXERC√çCIO 12 - UPDATE com JOIN e RETURNING
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: produtos, categorias

a) Atualize o nome de todos os produtos adicionando o prefixo com o nome da 
   categoria (ex: "Eletr√¥nicos - Notebook Dell")

b) Use RETURNING para retornar os produtos atualizados com id, nome antigo 
   (se poss√≠vel armazenar) e nome novo

c) Crie uma auditoria: adicione coluna "data_ultima_atualizacao" em produtos 
   e atualize-a sempre que houver mudan√ßa de pre√ßo

--------------------------------------------------------------------------------

EXERC√çCIO 13 - Dele√ß√£o com Integridade Referencial
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: pedidos, itens_pedido, clientes

a) Tente deletar um produto que possui itens em pedidos - observe o erro de FK
b) Delete todos os pedidos com status "cancelado" (isso deve deletar itens_pedido 
   automaticamente por CASCADE)
c) Delete clientes que nunca fizeram pedidos E est√£o inativos
d) Use DELETE com RETURNING para mostrar quais registros foram removidos

--------------------------------------------------------------------------------

EXERC√çCIO 14 - Transa√ß√µes e Controle de Concorr√™ncia
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: pedidos, itens_pedido, produtos

Simule um processo de cria√ß√£o de pedido dentro de uma transa√ß√£o:

a) Inicie uma transa√ß√£o (BEGIN)
b) Insira um novo pedido para um cliente
c) Insira 3 itens desse pedido
d) Atualize o valor_total do pedido com a soma dos itens
e) Para cada produto nos itens, SIMULE atualizar o estoque (voc√™ pode criar 
   coluna quantidade_estoque na tabela produtos)
f) Use SAVEPOINT antes de cada atualiza√ß√£o de estoque
g) Simule um erro (estoque insuficiente) e fa√ßa ROLLBACK para o savepoint
h) Ajuste a quantidade e refa√ßa
i) Fa√ßa COMMIT da transa√ß√£o completa

Demonstre tamb√©m:
- Um caso onde voc√™ faz ROLLBACK completo
- Consulta de n√≠vel de isolamento atual
- Mudan√ßa do n√≠vel de isolamento

================================================================================
                 SE√á√ÉO 3: CONSULTAS SIMPLES E FILTROS
================================================================================

EXERC√çCIO 15 - Proje√ß√£o e Sele√ß√£o B√°sica
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 10 minutos | üìä Tabelas: clientes, produtos

a) Liste todos os clientes mostrando apenas nome e email
b) Liste todos os produtos com pre√ßo acima de R$ 100,00
c) Liste clientes cadastrados nos √∫ltimos 30 dias
d) Liste produtos inativos de uma categoria espec√≠fica

--------------------------------------------------------------------------------

EXERC√çCIO 16 - Filtros com Operadores Diversos
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, clientes

Use diferentes operadores WHERE para:

a) Produtos com pre√ßo BETWEEN 50 AND 500
b) Clientes cujo nome come√ßa com 'A' ou 'M' (use LIKE ou ILIKE)
c) Produtos de m√∫ltiplas categorias usando IN
d) Clientes que N√ÉO t√™m telefone cadastrado (IS NULL)
e) Produtos com desconto diferente de zero (IS NOT NULL e <> 0)
f) Combine condi√ß√µes com AND, OR e par√™nteses: produtos ativos E (pre√ßo < 100 OU estoque_minimo < 10)

--------------------------------------------------------------------------------

EXERC√çCIO 17 - Ordena√ß√£o e Pagina√ß√£o
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 10 minutos | üìä Tabelas: produtos, clientes

a) Liste produtos ordenados por pre√ßo decrescente
b) Liste clientes ordenados por nome (ordem alfab√©tica)
c) Liste os 10 produtos mais caros
d) Implemente pagina√ß√£o: mostre produtos da p√°gina 2, com 5 itens por p√°gina 
   (use LIMIT e OFFSET)
e) Liste produtos ordenados por categoria (ascendente) e depois por pre√ßo 
   (descendente)

--------------------------------------------------------------------------------

EXERC√çCIO 18 - Fun√ß√µes de String e Data
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: clientes, pedidos

a) Mostre clientes com nome em MAI√öSCULAS
b) Extraia apenas o primeiro nome dos clientes
c) Concatene nome e email dos clientes no formato "Nome <email@exemplo.com>"
d) Calcule a idade dos clientes com base na data de nascimento
e) Mostre pedidos com a diferen√ßa em dias entre data_pedido e hoje
f) Formate a data_cadastro no formato brasileiro "dd/mm/yyyy"
g) Extraia o m√™s e ano do pedido separadamente

--------------------------------------------------------------------------------

EXERC√çCIO 19 - Express√µes CASE e Campos Calculados
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: produtos, clientes, pedidos

a) Classifique produtos por faixa de pre√ßo:
   - "Econ√¥mico" (< 50)
   - "Intermedi√°rio" (50-200)
   - "Premium" (> 200)

b) Classifique clientes por idade:
   - "Jovem" (18-30)
   - "Adulto" (31-50)
   - "S√™nior" (> 50)

c) Mostre o status do pedido traduzido para portugu√™s

d) Calcule o valor final dos itens_pedido considerando desconto:
   preco_unitario * quantidade * (1 - desconto/100)

--------------------------------------------------------------------------------

EXERC√çCIO 20 - Consultas com DISTINCT e Filtros de Texto
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, clientes

a) Liste todas as categorias √∫nicas de produtos (sem repeti√ß√£o)
b) Liste os diferentes status de pedidos existentes no banco
c) Busque produtos cujo nome cont√©m a palavra "Pro" (case-insensitive)
d) Busque clientes com email de dom√≠nio "gmail.com"
e) Use express√µes regulares (SIMILAR TO ou ~) para buscar CPFs com padr√£o espec√≠fico

================================================================================
                   SE√á√ÉO 4: JUN√á√ïES E RELACIONAMENTOS
================================================================================

EXERC√çCIO 21 - INNER JOIN B√°sico
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, categorias

a) Liste todos os produtos com o nome da categoria
b) Mostre produtos e categorias apenas onde h√° correspond√™ncia
c) Conte quantos produtos existem por categoria
d) Liste produtos com pre√ßo acima de 100 e mostre a categoria

--------------------------------------------------------------------------------

EXERC√çCIO 22 - LEFT/RIGHT OUTER JOIN
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: categorias, produtos, clientes, pedidos

a) Liste TODAS as categorias e a quantidade de produtos (mesmo categorias sem produtos)
b) Mostre TODOS os clientes e seus pedidos (incluindo clientes sem pedidos)
c) Identifique categorias sem nenhum produto
d) Identifique clientes que nunca fizeram pedidos
e) Use RIGHT JOIN para mostrar todos os pedidos e clientes (mesmo pedidos sem cliente - n√£o deveria acontecer)

--------------------------------------------------------------------------------

EXERC√çCIO 23 - M√∫ltiplas Jun√ß√µes
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: pedidos, itens_pedido, produtos, clientes, categorias

Crie uma consulta que mostre:
- N√∫mero do pedido
- Nome do cliente
- Data do pedido
- Nome do produto
- Categoria do produto
- Quantidade
- Pre√ßo unit√°rio
- Valor total do item (quantidade * pre√ßo)

Filtre apenas pedidos dos √∫ltimos 90 dias, ordene por data decrescente.

--------------------------------------------------------------------------------

EXERC√çCIO 24 - SELF JOIN
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabela: funcionarios (criar)

a) Crie uma tabela "funcionarios" com:
   - id_funcionario (PK)
   - nome
   - cargo
   - id_gerente (FK auto-refer√™ncia para id_funcionario)
   - salario

b) Insira dados hier√°rquicos (diretor > gerentes > analistas)

c) Use SELF JOIN para listar cada funcion√°rio com o nome do seu gerente

d) Liste gerentes e a quantidade de subordinados diretos

e) Identifique funcion√°rios sem gerente (diretores/presid√™ncia)

--------------------------------------------------------------------------------

EXERC√çCIO 25 - FULL OUTER JOIN e CROSS JOIN
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: diversas

a) Use FULL OUTER JOIN entre clientes e pedidos para mostrar:
   - Clientes sem pedidos
   - Pedidos sem cliente (√≥rf√£os - n√£o deveria existir)
   - Clientes com pedidos

b) Use CROSS JOIN para criar uma matriz de combina√ß√µes produto x categoria 
   (√∫til para an√°lise de possibilidades)

c) Use CROSS JOIN para criar uma tabela de datas (s√©rie temporal) cruzando 
   com produtos para an√°lise de vendas di√°rias

--------------------------------------------------------------------------------

EXERC√çCIO 26 - Jun√ß√µes com Condi√ß√µes Complexas
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: pedidos, itens_pedido, produtos, clientes

a) Liste pedidos onde o valor total do pedido seja maior que o limite de 
   cr√©dito do cliente (situa√ß√£o de risco)

b) Mostre produtos que aparecem em pedidos de mais de 5 clientes diferentes

c) Liste clientes que compraram produtos de TODAS as categorias dispon√≠veis

d) Encontre pares de produtos que foram comprados juntos (no mesmo pedido) 
   com frequ√™ncia

================================================================================
              SE√á√ÉO 5: FUN√á√ïES AGREGADAS E AGRUPAMENTO
================================================================================

EXERC√çCIO 27 - Fun√ß√µes Agregadas B√°sicas
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, pedidos, clientes

Calcule:
a) Total de produtos cadastrados
b) Pre√ßo m√©dio dos produtos
c) Produto mais caro e mais barato (MAX, MIN)
d) Soma total de todos os pedidos
e) Quantidade total de clientes ativos vs inativos
f) Data do primeiro e do √∫ltimo pedido

--------------------------------------------------------------------------------

EXERC√çCIO 28 - GROUP BY Simples
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, pedidos

a) Quantidade de produtos por categoria
b) Valor m√©dio de produtos por categoria
c) Quantidade de pedidos por status
d) Total de vendas (valor_total) por status de pedido
e) Quantidade de pedidos por m√™s/ano

--------------------------------------------------------------------------------

EXERC√çCIO 29 - GROUP BY com HAVING
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: produtos, categorias, pedidos, clientes

a) Categorias com mais de 3 produtos
b) Categorias onde o pre√ßo m√©dio dos produtos √© superior a R$ 200
c) Clientes que fizeram mais de 5 pedidos
d) Meses onde o total de vendas foi acima de R$ 10.000
e) Produtos que aparecem em mais de 10 pedidos diferentes

--------------------------------------------------------------------------------

EXERC√çCIO 30 - Agrupamento com M√∫ltiplas Colunas
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: pedidos, itens_pedido, produtos, categorias

a) Total de vendas por categoria e por m√™s
b) Quantidade de pedidos por cliente e por status
c) Valor m√©dio do pedido por cliente e por per√≠odo (trimestre)
d) Produto mais vendido (quantidade) por categoria

--------------------------------------------------------------------------------

EXERC√çCIO 31 - Fun√ß√µes de Janela (Window Functions) B√°sicas
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: produtos, pedidos, clientes

a) Ranking de produtos mais caros (use ROW_NUMBER, RANK, DENSE_RANK)
b) Mostre cada pedido com o total acumulado de vendas (RUNNING TOTAL com SUM OVER)
c) Para cada produto, mostre a diferen√ßa de pre√ßo em rela√ß√£o √† m√©dia da categoria (usando AVG OVER PARTITION BY)
d) Identifique o produto mais caro e mais barato de cada categoria (FIRST_VALUE, LAST_VALUE)

--------------------------------------------------------------------------------

EXERC√çCIO 32 - Agrega√ß√µes Avan√ßadas com ROLLUP e CUBE
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 30 minutos | üìä Tabelas: pedidos, itens_pedido, produtos

a) Use GROUP BY com ROLLUP para mostrar:
   - Total de vendas por categoria
   - Total de vendas por categoria e produto
   - Total geral de vendas

b) Use GROUPING SETS para an√°lises multidimensionais:
   - Vendas por categoria
   - Vendas por m√™s
   - Vendas totais
   Tudo em uma √∫nica consulta

c) Calcule percentuais de participa√ß√£o de cada categoria no total de vendas

d) Crie relat√≥rio com SUBTOTAIS e TOTAL GERAL

================================================================================
            SE√á√ÉO 6: SUBCONSULTAS E CONSULTAS AVAN√áADAS
================================================================================

EXERC√çCIO 33 - Subconsultas Simples no WHERE
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, pedidos, clientes

a) Liste produtos com pre√ßo acima da m√©dia geral
b) Mostre clientes que fizeram pedidos acima do valor m√©dio
c) Encontre produtos que nunca foram vendidos (NOT IN ou NOT EXISTS)
d) Liste categorias que t√™m produtos acima de R$ 1.000

--------------------------------------------------------------------------------

EXERC√çCIO 34 - Subconsultas Correlacionadas
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: produtos, categorias, pedidos, clientes

a) Para cada categoria, mostre produtos com pre√ßo acima da m√©dia DAQUELA categoria
b) Liste clientes cujo total de pedidos est√° acima da m√©dia de pedidos por cliente
c) Mostre o pedido mais recente de cada cliente usando subconsulta correlacionada
d) Identifique produtos que t√™m pre√ßo maior que TODOS os produtos de outra categoria espec√≠fica

--------------------------------------------------------------------------------

EXERC√çCIO 35 - Subconsultas no SELECT e FROM
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: clientes, pedidos, produtos

a) Liste clientes com uma coluna adicional mostrando a quantidade de pedidos 
   (subconsulta escalar no SELECT)

b) Mostre produtos com coluna de "quantidade vendida total" usando subconsulta

c) Use subconsulta na cl√°usula FROM (derived table) para calcular primeiro as 
   vendas por categoria, depois filtrar as top 3

d) Combine JOIN com subconsulta para otimizar performance

--------------------------------------------------------------------------------

EXERC√çCIO 36 - EXISTS e NOT EXISTS
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: clientes, pedidos, produtos, categorias

a) Clientes que T√äM pedidos (usando EXISTS)
b) Clientes que N√ÉO T√äM pedidos (usando NOT EXISTS)
c) Categorias que T√äM produtos ativos
d) Produtos que EXISTEM em pelo menos um pedido do √∫ltimo m√™s
e) Compare performance de EXISTS vs IN em um caso pr√°tico

--------------------------------------------------------------------------------

EXERC√çCIO 37 - CTEs (Common Table Expressions)
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 30 minutos | üìä Tabelas: pedidos, itens_pedido, produtos, clientes

Use WITH para criar CTEs:

a) CTE simples: calcule totais de vendas por cliente, depois use na consulta principal
b) M√∫ltiplas CTEs: separe l√≥gica de c√°lculos intermedi√°rios
c) CTE recursiva: se voc√™ criou a tabela de funcion√°rios hier√°rquica, navegue 
   pela hierarquia completa (subordinados de subordinados)
d) Use CTE para melhorar legibilidade de consulta complexa de relat√≥rio

--------------------------------------------------------------------------------

EXERC√çCIO 38 - UNION, INTERSECT e EXCEPT
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: clientes, produtos, pedidos

a) UNION: combine clientes ativos e clientes com pedidos recentes (remova duplicatas)
b) UNION ALL: mostre todos os eventos (pedidos criados, cancelados) em ordem cronol√≥gica
c) INTERSECT: encontre clientes que s√£o ativos E fizeram pedidos no √∫ltimo trimestre
d) EXCEPT: clientes ativos que N√ÉO fizeram pedidos no √∫ltimo ano
e) Combine operadores: (A UNION B) EXCEPT C

================================================================================
                  SE√á√ÉO 7: VIEWS E PERFORMANCE
================================================================================

EXERC√çCIO 39 - Cria√ß√£o de Views Simples
üü¢ N√≠vel: F√°cil | ‚è±Ô∏è Tempo: 15 minutos | üìä Tabelas: produtos, categorias, clientes, pedidos

Crie as seguintes views:

a) v_produtos_completos: produtos com nome da categoria
b) v_clientes_ativos: apenas clientes com status_ativo = true
c) v_pedidos_recentes: pedidos dos √∫ltimos 30 dias com dados do cliente
d) v_resumo_vendas: totaliza√ß√£o de vendas por categoria

Teste as views fazendo SELECT e filtros adicionais.

--------------------------------------------------------------------------------

EXERC√çCIO 40 - Views Atualiz√°veis e Complexas
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: produtos, clientes

a) Crie uma view simples sobre produtos que seja atualiz√°vel
b) Tente fazer UPDATE atrav√©s da view
c) Crie uma view complexa (com JOIN e agrega√ß√µes) e tente atualiz√°-la - observe a limita√ß√£o
d) Use CREATE OR REPLACE VIEW para modificar uma view existente
e) Use DROP VIEW e IF EXISTS

--------------------------------------------------------------------------------

EXERC√çCIO 41 - Materialized Views
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: pedidos, itens_pedido, produtos

a) Crie uma MATERIALIZED VIEW para relat√≥rio pesado de vendas:
   - Total de vendas por produto
   - Quantidade vendida
   - Ticket m√©dio
   - √öltima venda

b) Consulte a materialized view e observe a velocidade

c) Insira novos dados nas tabelas base

d) Observe que a materialized view n√£o atualizou automaticamente

e) Use REFRESH MATERIALIZED VIEW para atualizar

f) Crie √≠ndice na materialized view para melhorar consultas

g) Configure refresh com CONCURRENTLY (requer UNIQUE INDEX)

--------------------------------------------------------------------------------

EXERC√çCIO 42 - An√°lise de Performance com EXPLAIN
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 30 minutos | üìä Tabelas: pedidos, produtos, clientes

a) Execute EXPLAIN em uma consulta simples (SELECT * FROM produtos)

b) Execute EXPLAIN ANALYZE em consulta com JOIN

c) Interprete o plano: Seq Scan, Index Scan, Nested Loop, Hash Join

d) Crie um √≠ndice estrat√©gico e compare o EXPLAIN antes/depois

e) Identifique consultas lentas (Seq Scan em tabelas grandes)

f) Use EXPLAIN para consulta com subconsulta correlacionada - observe o custo

g) Otimize a consulta e compare novamente

--------------------------------------------------------------------------------

EXERC√çCIO 43 - Cria√ß√£o de √çndices Estrat√©gicos
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: produtos, pedidos, clientes

a) Crie √≠ndice B-Tree padr√£o em produtos.nome

b) Crie √≠ndice composto em (id_categoria, preco) para otimizar buscas espec√≠ficas

c) Crie √≠ndice parcial: apenas produtos ativos

d) Crie √≠ndice em express√£o: LOWER(email) para buscas case-insensitive

e) Para campo JSONB (contato em fornecedores), crie √≠ndice GIN

f) Para busca textual, configure pg_trgm e crie √≠ndice GIN em produtos.descricao

g) Mostre como listar todos os √≠ndices de uma tabela

h) Discuta trade-offs: √≠ndices aceleram SELECT mas atrasam INSERT/UPDATE

================================================================================
            SE√á√ÉO 8: FUN√á√ïES, PROCEDURES E TRIGGERS
================================================================================

EXERC√çCIO 44 - Cria√ß√£o de Fun√ß√µes SQL Simples
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Tabelas: produtos, clientes

Crie as seguintes fun√ß√µes:

a) Fun√ß√£o calcular_idade(data_nascimento DATE) RETURNS INTEGER
   - Retorna idade em anos completos

b) Fun√ß√£o calcular_desconto(preco DECIMAL, percentual DECIMAL) RETURNS DECIMAL
   - Retorna pre√ßo com desconto aplicado

c) Fun√ß√£o obter_total_pedidos_cliente(cliente_id INT) RETURNS DECIMAL
   - Retorna soma de todos os pedidos do cliente

d) Teste as fun√ß√µes com SELECT

--------------------------------------------------------------------------------

EXERC√çCIO 45 - Fun√ß√µes PL/pgSQL Complexas
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 30 minutos | üìä Tabelas: produtos, pedidos

Crie fun√ß√µes usando PL/pgSQL:

a) Fun√ß√£o aplicar_reajuste_categoria(cat_id INT, percentual DECIMAL) RETURNS TEXT
   - Atualiza pre√ßos de todos os produtos da categoria
   - Retorna mensagem com quantidade de produtos atualizados
   - Use controle de fluxo (IF)

b) Fun√ß√£o gerar_relatorio_vendas(data_inicio DATE, data_fim DATE) 
   RETURNS TABLE (categoria TEXT, total DECIMAL, qtd_pedidos INT)
   - Retorna tabela com totaliza√ß√µes

c) Fun√ß√£o validar_estoque_pedido(pedido_id INT) RETURNS BOOLEAN
   - Verifica se h√° estoque para todos os itens do pedido
   - Use LOOP para percorrer itens

d) Use blocos EXCEPTION para tratamento de erros

--------------------------------------------------------------------------------

EXERC√çCIO 46 - Stored Procedures
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas: pedidos, itens_pedido, produtos

a) Crie PROCEDURE processar_pedido(cliente_id INT, produto_ids INT[], quantidades INT[])
   - Cria um pedido
   - Insere itens
   - Atualiza estoque
   - Calcula total
   - Tudo em uma transa√ß√£o
   - Com COMMIT/ROLLBACK interno

b) Crie PROCEDURE cancelar_pedido(pedido_id INT)
   - Atualiza status para cancelado
   - Restaura estoque
   - Registra log de auditoria

c) Execute as procedures com CALL

--------------------------------------------------------------------------------

EXERC√çCIO 47 - Triggers B√°sicos
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 30 minutos | üìä Tabelas: produtos, pedidos, auditoria

a) Crie tabela auditoria_produtos:
   - id, id_produto, acao (INSERT/UPDATE/DELETE), data_hora, usuario, dados_antigos, dados_novos

b) Crie fun√ß√£o de trigger para auditoria

c) Crie TRIGGER que registra todas as mudan√ßas em produtos

d) Crie trigger BEFORE INSERT em pedidos para:
   - Validar que cliente existe e est√° ativo
   - Definir data_pedido se NULL
   - Definir status padr√£o

e) Crie trigger AFTER INSERT em itens_pedido para:
   - Atualizar automaticamente o valor_total do pedido

f) Teste os triggers inserindo/atualizando/deletando dados

--------------------------------------------------------------------------------

EXERC√çCIO 48 - Triggers Avan√ßados e Constraints Complexas
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 35 minutos | üìä Tabelas: pedidos, produtos, movimentacoes_estoque

a) Crie trigger que impede deletar categoria se houver produtos ativos

b) Crie trigger que atualiza estoque automaticamente ao inserir movimenta√ß√£o

c) Crie trigger que impede pedido se cliente exceder limite de cr√©dito

d) Crie trigger de valida√ß√£o complexa: pedido s√≥ pode ser cancelado se n√£o foi enviado

e) Use NEW e OLD em triggers de UPDATE

f) Crie trigger condicional (s√≥ dispara em certas condi√ß√µes com WHEN)

g) Gerencie ordem de execu√ß√£o de m√∫ltiplos triggers (nomes alfab√©ticos ou prioridade)

================================================================================
               SE√á√ÉO 9: ADMINISTRA√á√ÉO E OTIMIZA√á√ÉO
================================================================================

EXERC√çCIO 49 - Backup e Restore
üü° N√≠vel: M√©dio | ‚è±Ô∏è Tempo: 20 minutos | üìä Todo o banco

a) Use pg_dump para fazer backup do banco "loja_virtual" (formato custom)

b) Use pg_dumpall para backup de todos os bancos (incluindo roles)

c) Fa√ßa backup apenas do schema "vendas"

d) Exporte apenas dados (sem estrutura) de uma tabela espec√≠fica

e) Restaure o backup em um novo banco "loja_virtual_restore"

f) No DBeaver: use a interface para exportar dados para SQL, CSV, JSON

g) Importe CSV usando COPY ou \copy

h) Documente o processo completo passo-a-passo

--------------------------------------------------------------------------------

EXERC√çCIO 50 - Gest√£o de Usu√°rios e Permiss√µes
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 30 minutos | üìä Banco completo

a) Crie roles:
   - role_admin (acesso total)
   - role_vendedor (SELECT, INSERT, UPDATE em vendas)
   - role_consulta (apenas SELECT)

b) Crie usu√°rios:
   - user_admin (membro de role_admin)
   - user_vendedor1, user_vendedor2 (membros de role_vendedor)
   - user_relatorio (membro de role_consulta)

c) Configure permiss√µes granulares:
   - GRANT SELECT ON vendas.produtos TO role_consulta
   - GRANT INSERT, UPDATE ON vendas.pedidos TO role_vendedor
   - GRANT ALL ON ALL TABLES IN SCHEMA vendas TO role_admin

d) Teste conectando com diferentes usu√°rios e tentando opera√ß√µes

e) Revogue permiss√µes espec√≠ficas com REVOKE

f) Configure permiss√µes padr√£o (ALTER DEFAULT PRIVILEGES)

g) Documente estrutura de seguran√ßa

--------------------------------------------------------------------------------

EXERC√çCIO 51 - Manuten√ß√£o e Vacuum
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 25 minutos | üìä Tabelas grandes

a) Execute VACUUM em uma tabela espec√≠fica

b) Execute VACUUM FULL para recuperar espa√ßo em disco

c) Execute ANALYZE para atualizar estat√≠sticas do planejador

d) Execute VACUUM ANALYZE (combinado)

e) Configure autovacuum (par√¢metros no postgresql.conf ou por tabela)

f) Use REINDEX para reconstruir √≠ndices

g) Monitore bloat (espa√ßo desperdi√ßado) em tabelas e √≠ndices

h) Execute CLUSTER para reordenar tabela fisicamente por √≠ndice

--------------------------------------------------------------------------------

EXERC√çCIO 52 - Monitoramento e Queries do Cat√°logo
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 30 minutos | üìä Sistema

Consulte views do sistema para:

a) pg_stat_activity: conex√µes ativas, queries em execu√ß√£o

b) pg_stat_user_tables: estat√≠sticas de uso das tabelas (seq scans, index scans)

c) pg_indexes: listar todos os √≠ndices

d) pg_tables: listar todas as tabelas

e) information_schema.columns: metadados das colunas

f) pg_size_pretty(pg_total_relation_size('tabela')): tamanho das tabelas

g) Identifique queries lentas em pg_stat_statements (extens√£o)

h) Crie consulta para listar TOP 10 tabelas maiores

i) Crie consulta para listar √≠ndices n√£o utilizados

j) Monitore locks e bloqueios (pg_locks)

================================================================================
                  SE√á√ÉO 10: PROJETOS INTEGRADOS
================================================================================

EXERC√çCIO 53 - Projeto: Sistema de Pedidos Completo
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 120 minutos | üìä Todas as tabelas

Desenvolva um sistema completo de pedidos:

**Requisitos:**

1. **Modelagem:**
   - Crie diagrama ER completo
   - Implemente todas as tabelas necess√°rias (clientes, produtos, categorias, 
     pedidos, itens_pedido, fornecedores, movimentacoes_estoque)
   - Configure todas as constraints, FKs, √≠ndices

2. **Carga de Dados:**
   - Insira pelo menos 50 clientes
   - 10 categorias
   - 100 produtos
   - 200 pedidos
   - 500 itens de pedidos
   - Use transa√ß√µes para garantir consist√™ncia

3. **Regras de Neg√≥cio (via triggers/functions):**
   - Atualizar valor_total do pedido automaticamente
   - Controlar estoque nas movimenta√ß√µes
   - Impedir venda sem estoque
   - Validar limite de cr√©dito do cliente
   - Auditoria de todas as opera√ß√µes cr√≠ticas

4. **Relat√≥rios (views/queries):**
   - Top 10 clientes por valor total de compras
   - Produtos mais vendidos
   - An√°lise de vendas por categoria/m√™s
   - Clientes inativos (sem compra h√° 6 meses)
   - Produtos com estoque baixo
   - Dashboard gerencial (materialized view)

5. **Performance:**
   - Crie √≠ndices estrat√©gicos
   - Otimize as queries principais
   - Use EXPLAIN para validar

6. **Seguran√ßa:**
   - Configure roles e usu√°rios
   - Implemente RLS (Row Level Security) se aplic√°vel

7. **Backup:**
   - Procedimento de backup completo
   - Teste de restore

**Entreg√°veis:**
- Script SQL completo
- Documenta√ß√£o do modelo
- Manual de uso
- Relat√≥rio de testes de performance

--------------------------------------------------------------------------------

EXERC√çCIO 54 - Projeto: Sistema de Biblioteca
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 120 minutos | üìä Novo schema

Crie um sistema de biblioteca com:

**Entidades:**
- Livros (t√≠tulo, ISBN, editora, ano, categoria, quantidade_total)
- Autores (com relacionamento N:N com livros)
- Usu√°rios/Membros
- Empr√©stimos (data_emprestimo, data_prevista_devolucao, data_devolucao_real)
- Multas

**Funcionalidades:**

1. Registrar empr√©stimo:
   - Verificar disponibilidade
   - Registrar data de devolu√ß√£o prevista (14 dias)
   - Verificar se usu√°rio tem multas pendentes
   - Decrementar quantidade dispon√≠vel

2. Registrar devolu√ß√£o:
   - Calcular se h√° atraso
   - Gerar multa se atrasado
   - Incrementar quantidade dispon√≠vel

3. Relat√≥rios:
   - Livros mais emprestados
   - Usu√°rios com mais empr√©stimos
   - Livros atrasados
   - Receita de multas por per√≠odo
   - Taxa de ocupa√ß√£o da biblioteca

4. Implementar:
   - Triggers para regras de neg√≥cio
   - Functions para c√°lculos
   - Views para relat√≥rios
   - √çndices para performance
   - Auditoria

5. Dados de teste:
   - 200 livros
   - 50 autores
   - 100 usu√°rios
   - 500 empr√©stimos (hist√≥rico)

--------------------------------------------------------------------------------

EXERC√çCIO 55 - Projeto: Sistema de RH
üî¥ N√≠vel: Avan√ßado | ‚è±Ô∏è Tempo: 120 minutos | üìä Novo schema

Desenvolva sistema de Recursos Humanos:

**Estrutura:**
- Departamentos (hierarquia com SELF JOIN)
- Cargos (com faixas salariais)
- Funcion√°rios (auto-refer√™ncia para gerente)
- Hist√≥rico de cargos
- Folha de pagamento
- Benef√≠cios
- Avalia√ß√µes de desempenho

**Requisitos:**

1. Modelagem hier√°rquica:
   - Departamentos com subdepartamentos
   - Funcion√°rios com gerentes
   - Use CTE recursiva para navegar hierarquia

2. Regras de neg√≥cio:
   - Sal√°rio deve estar na faixa do cargo
   - Funcion√°rio n√£o pode ser gerente de si mesmo
   - Hist√≥rico de mudan√ßas de cargo
   - C√°lculo de tempo de casa

3. Funcionalidades:
   - Promo√ß√£o de funcion√°rio (procedure)
   - C√°lculo de folha com descontos e benef√≠cios
   - Relat√≥rio de aniversariantes do m√™s
   - Organograma (query recursiva)
   - An√°lise de turnover

4. Queries complexas:
   - M√©dia salarial por departamento
   - Funcion√°rios eleg√≠veis para promo√ß√£o (tempo m√≠nimo no cargo)
   - Custo total da folha por centro de custo
   - An√°lise de performance com window functions

5. Otimiza√ß√£o:
   - √çndices adequados
   - Materialized views para dashboards
   - Particionamento da folha de pagamento por m√™s/ano

6. Seguran√ßa:
   - RLS: funcion√°rios s√≥ veem pr√≥prios dados
   - Gestores veem subordinados
   - RH v√™ tudo

================================================================================
                              OBSERVA√á√ïES FINAIS
================================================================================

**Instru√ß√µes Gerais:**
- Todos os exerc√≠cios devem ser executados no PostgreSQL 14+
- Use DBeaver para gerenciar conex√µes e executar scripts
- Scripts completos est√£o em "scripts.sql"
- Gabaritos completos em "gabarito_bd_postgres.txt"
- Plano de aula detalhado em "plano_aula_bd_postgres.txt"

**Dicas de Estudo:**
- Comece pelos exerc√≠cios f√°ceis de cada se√ß√£o
- N√£o pule para avan√ßado sem dominar o m√©dio
- Pratique, pratique, pratique
- Use EXPLAIN para entender o que o PostgreSQL est√° fazendo
- Consulte a documenta√ß√£o oficial: https://www.postgresql.org/docs/

**Tempo Total Estimado:**
- Exerc√≠cios F√°ceis (1-20): ~4-5 horas
- Exerc√≠cios M√©dios (21-40): ~10-12 horas  
- Exerc√≠cios Avan√ßados (41-52): ~12-15 horas
- Projetos Integrados (53-55): ~6-8 horas
- **TOTAL: ~35-40 horas de pr√°tica**

Bons estudos! üöÄ

================================================================================
                                  FIM
================================================================================
