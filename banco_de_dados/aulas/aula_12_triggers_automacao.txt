================================================================================
                              AULA 12 - DIA 12
                         TRIGGERS E AUTOMA√á√ÉO DE BANCO
================================================================================

HOR√ÅRIO: 13:30 - 17:30 | DATA: _____/_____/_____

OBJETIVOS:
‚úì Compreender conceito e tipos de triggers
‚úì Criar triggers BEFORE e AFTER
‚úì Implementar triggers de auditoria
‚úì Automatizar regras de neg√≥cio

CRONOGRAMA:
13:30-14:30 ‚Üí Fundamentos de Triggers
14:30-15:30 ‚Üí Triggers BEFORE/AFTER
15:30-15:45 ‚Üí Intervalo
15:45-16:30 ‚Üí Triggers de Auditoria
16:30-17:30 ‚Üí Projeto Pr√°tico

================================================================================
1. O QUE S√ÉO TRIGGERS?
================================================================================

CONCEITO:
Triggers (gatilhos) s√£o procedimentos executados AUTOMATICAMENTE quando
eventos espec√≠ficos ocorrem (INSERT, UPDATE, DELETE).

USOS COMUNS:
‚úì Auditoria (registrar quem/quando modificou)
‚úì Valida√ß√£o de dados
‚úì Atualiza√ß√£o autom√°tica de campos
‚úì Manuten√ß√£o de integridade
‚úì Replica√ß√£o de dados
‚úì Notifica√ß√µes

TIPOS:
1. BEFORE ‚Üí executa ANTES da opera√ß√£o (pode modificar/cancelar)
2. AFTER ‚Üí executa DEPOIS da opera√ß√£o (dados j√° gravados)

N√çVEIS:
- FOR EACH ROW ‚Üí executa para cada linha afetada
- FOR EACH STATEMENT ‚Üí executa uma vez por comando

================================================================================
2. ESTRUTURA B√ÅSICA
================================================================================

PASSO 1: Criar fun√ß√£o trigger
CREATE OR REPLACE FUNCTION nome_funcao_trigger()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    -- l√≥gica aqui
    RETURN NEW;  -- ou OLD, ou NULL
END;
$$;

PASSO 2: Criar trigger
CREATE TRIGGER nome_trigger
BEFORE/AFTER INSERT/UPDATE/DELETE ON tabela
FOR EACH ROW
EXECUTE FUNCTION nome_funcao_trigger();

üí° NEW ‚Üí registro novo (INSERT/UPDATE)
üí° OLD ‚Üí registro antigo (UPDATE/DELETE)
üí° RETURN NEW ‚Üí permite opera√ß√£o
üí° RETURN NULL ‚Üí cancela opera√ß√£o

================================================================================
3. TRIGGERS BEFORE
================================================================================

EXEMPLO 1: Valida√ß√£o Autom√°tica
--------------------------------------------------------------------------------

-- Garantir que pre√ßo n√£o seja negativo
CREATE OR REPLACE FUNCTION validar_preco()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    IF NEW.preco < 0 THEN
        RAISE EXCEPTION 'Pre√ßo n√£o pode ser negativo: %', NEW.preco;
    END IF;
    
    RETURN NEW;
END;
$$;

CREATE TRIGGER trg_validar_preco
BEFORE INSERT OR UPDATE ON produtos
FOR EACH ROW
EXECUTE FUNCTION validar_preco();

-- üí° BEFORE ‚Üí valida ANTES de gravar
-- üí° RAISE EXCEPTION ‚Üí cancela opera√ß√£o

-- Testando:
INSERT INTO produtos (nome, preco, categoria_id) 
VALUES ('Teste', -10, 1);  -- ERRO!

--------------------------------------------------------------------------------

EXEMPLO 2: Modifica√ß√£o Autom√°tica de Valores
--------------------------------------------------------------------------------

-- Converter email para min√∫sculas e remover espa√ßos
CREATE OR REPLACE FUNCTION normalizar_email()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    NEW.email := LOWER(TRIM(NEW.email));
    RETURN NEW;
END;
$$;

CREATE TRIGGER trg_normalizar_email
BEFORE INSERT OR UPDATE ON clientes
FOR EACH ROW
EXECUTE FUNCTION normalizar_email();

-- üí° Modifica NEW antes de gravar
-- üí° Garante padr√£o de dados

-- Testando:
INSERT INTO clientes (nome, email) 
VALUES ('Jo√£o', '  JOAO@EMAIL.COM  ');
-- Gravar√°: 'joao@email.com'

--------------------------------------------------------------------------------

EXEMPLO 3: Atualizar Timestamp Automaticamente
--------------------------------------------------------------------------------

-- Atualizar data_atualizacao sempre que registro for modificado
CREATE OR REPLACE FUNCTION atualizar_timestamp()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    NEW.data_atualizacao := CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;

-- Aplicar em m√∫ltiplas tabelas:
CREATE TRIGGER trg_atualizar_timestamp_produtos
BEFORE UPDATE ON produtos
FOR EACH ROW
EXECUTE FUNCTION atualizar_timestamp();

CREATE TRIGGER trg_atualizar_timestamp_clientes
BEFORE UPDATE ON clientes
FOR EACH ROW
EXECUTE FUNCTION atualizar_timestamp();

-- üí° Uma fun√ß√£o pode ser usada em v√°rios triggers
-- üí° Comum para campos de auditoria

================================================================================
4. TRIGGERS AFTER
================================================================================

EXEMPLO 4: Atualizar Totais Automaticamente
--------------------------------------------------------------------------------

-- Atualizar valor_total do pedido ao inserir/atualizar item
CREATE OR REPLACE FUNCTION atualizar_total_pedido()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_pedido_id INTEGER;
BEGIN
    -- Determinar qual pedido atualizar
    IF TG_OP = 'DELETE' THEN
        v_pedido_id := OLD.pedido_id;
    ELSE
        v_pedido_id := NEW.pedido_id;
    END IF;
    
    -- Recalcular total
    UPDATE pedidos
    SET valor_total = (
        SELECT COALESCE(SUM(quantidade * preco_unitario), 0)
        FROM itens_pedido
        WHERE pedido_id = v_pedido_id
    )
    WHERE id = v_pedido_id;
    
    IF TG_OP = 'DELETE' THEN
        RETURN OLD;
    ELSE
        RETURN NEW;
    END IF;
END;
$$;

CREATE TRIGGER trg_atualizar_total_pedido
AFTER INSERT OR UPDATE OR DELETE ON itens_pedido
FOR EACH ROW
EXECUTE FUNCTION atualizar_total_pedido();

-- üí° TG_OP ‚Üí indica opera√ß√£o (INSERT/UPDATE/DELETE)
-- üí° AFTER ‚Üí executa depois de gravar item
-- üí° Mant√©m integridade de totais

-- Testando:
INSERT INTO itens_pedido (pedido_id, produto_id, quantidade, preco_unitario)
VALUES (1, 5, 3, 25.00);
-- Pedido 1 ter√° valor_total atualizado automaticamente

--------------------------------------------------------------------------------

EXEMPLO 5: Controle de Estoque Autom√°tico
--------------------------------------------------------------------------------

-- Dar baixa no estoque ao confirmar pedido
CREATE OR REPLACE FUNCTION controlar_estoque()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_item RECORD;
BEGIN
    -- Quando pedido √© confirmado
    IF NEW.status = 'CONFIRMADO' AND OLD.status <> 'CONFIRMADO' THEN
        FOR v_item IN 
            SELECT produto_id, quantidade 
            FROM itens_pedido 
            WHERE pedido_id = NEW.id
        LOOP
            UPDATE produtos
            SET estoque = estoque - v_item.quantidade
            WHERE id = v_item.produto_id;
            
            -- Verificar estoque negativo
            IF (SELECT estoque FROM produtos WHERE id = v_item.produto_id) < 0 THEN
                RAISE EXCEPTION 'Estoque insuficiente para produto %', v_item.produto_id;
            END IF;
        END LOOP;
    END IF;
    
    -- Quando pedido √© cancelado
    IF NEW.status = 'CANCELADO' AND OLD.status <> 'CANCELADO' THEN
        FOR v_item IN 
            SELECT produto_id, quantidade 
            FROM itens_pedido 
            WHERE pedido_id = NEW.id
        LOOP
            UPDATE produtos
            SET estoque = estoque + v_item.quantidade
            WHERE id = v_item.produto_id;
        END LOOP;
    END IF;
    
    RETURN NEW;
END;
$$;

CREATE TRIGGER trg_controlar_estoque
AFTER UPDATE ON pedidos
FOR EACH ROW
EXECUTE FUNCTION controlar_estoque();

-- üí° Compara OLD.status com NEW.status
-- üí° Automatiza regra de neg√≥cio cr√≠tica

================================================================================
5. TRIGGERS DE AUDITORIA
================================================================================

EXEMPLO 6: Log de Altera√ß√µes Completo
--------------------------------------------------------------------------------

-- Tabela de auditoria
CREATE TABLE auditoria (
    id SERIAL PRIMARY KEY,
    tabela VARCHAR(50),
    operacao VARCHAR(10),
    usuario VARCHAR(100),
    data_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    registro_antigo JSONB,
    registro_novo JSONB
);

-- Fun√ß√£o gen√©rica de auditoria
CREATE OR REPLACE FUNCTION auditar_alteracoes()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO auditoria (tabela, operacao, usuario, registro_antigo, registro_novo)
    VALUES (
        TG_TABLE_NAME,
        TG_OP,
        CURRENT_USER,
        CASE WHEN TG_OP = 'INSERT' THEN NULL ELSE row_to_json(OLD)::JSONB END,
        CASE WHEN TG_OP = 'DELETE' THEN NULL ELSE row_to_json(NEW)::JSONB END
    );
    
    IF TG_OP = 'DELETE' THEN
        RETURN OLD;
    ELSE
        RETURN NEW;
    END IF;
END;
$$;

-- Aplicar em tabelas importantes
CREATE TRIGGER trg_auditoria_produtos
AFTER INSERT OR UPDATE OR DELETE ON produtos
FOR EACH ROW
EXECUTE FUNCTION auditar_alteracoes();

CREATE TRIGGER trg_auditoria_clientes
AFTER INSERT OR UPDATE OR DELETE ON clientes
FOR EACH ROW
EXECUTE FUNCTION auditar_alteracoes();

-- üí° TG_TABLE_NAME ‚Üí nome da tabela que disparou trigger
-- üí° JSONB ‚Üí armazena registro completo em formato JSON
-- üí° row_to_json() ‚Üí converte linha em JSON

-- Consultando auditoria:
SELECT 
    tabela,
    operacao,
    usuario,
    data_hora,
    registro_novo->>'nome' AS novo_nome,
    registro_antigo->>'nome' AS nome_anterior
FROM auditoria
WHERE tabela = 'produtos'
ORDER BY data_hora DESC
LIMIT 10;

================================================================================
6. TRIGGERS AVAN√áADOS
================================================================================

EXEMPLO 7: Prevenir Opera√ß√µes
--------------------------------------------------------------------------------

-- Impedir exclus√£o de pedidos confirmados
CREATE OR REPLACE FUNCTION proteger_pedidos_confirmados()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    IF OLD.status = 'CONFIRMADO' THEN
        RAISE EXCEPTION 'N√£o √© poss√≠vel excluir pedido confirmado!';
    END IF;
    RETURN OLD;
END;
$$;

CREATE TRIGGER trg_proteger_pedidos
BEFORE DELETE ON pedidos
FOR EACH ROW
EXECUTE FUNCTION proteger_pedidos_confirmados();

--------------------------------------------------------------------------------

EXEMPLO 8: Notifica√ß√£o/Alertas
--------------------------------------------------------------------------------

-- Notificar quando estoque ficar baixo
CREATE OR REPLACE FUNCTION notificar_estoque_baixo()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    IF NEW.estoque < NEW.estoque_minimo AND 
       (OLD.estoque IS NULL OR OLD.estoque >= OLD.estoque_minimo) THEN
        
        RAISE NOTICE 'ALERTA: Produto % (ID: %) est√° com estoque baixo: %',
            NEW.nome, NEW.id, NEW.estoque;
        
        -- Aqui poderia enviar email, criar task, etc.
    END IF;
    
    RETURN NEW;
END;
$$;

CREATE TRIGGER trg_notificar_estoque
AFTER INSERT OR UPDATE ON produtos
FOR EACH ROW
EXECUTE FUNCTION notificar_estoque_baixo();

================================================================================
7. GERENCIAMENTO DE TRIGGERS
================================================================================

-- Listar todos os triggers:
SELECT 
    trigger_name,
    event_object_table AS tabela,
    action_timing AS momento,
    event_manipulation AS evento
FROM information_schema.triggers
WHERE trigger_schema = 'public'
ORDER BY event_object_table, trigger_name;

-- Desabilitar trigger:
ALTER TABLE produtos DISABLE TRIGGER trg_validar_preco;

-- Habilitar trigger:
ALTER TABLE produtos ENABLE TRIGGER trg_validar_preco;

-- Remover trigger:
DROP TRIGGER IF EXISTS trg_validar_preco ON produtos;

-- Desabilitar TODOS os triggers de uma tabela:
ALTER TABLE produtos DISABLE TRIGGER ALL;

-- Habilitar TODOS os triggers de uma tabela:
ALTER TABLE produtos ENABLE TRIGGER ALL;

================================================================================
8. BOAS PR√ÅTICAS
================================================================================

‚úì Use triggers com modera√ß√£o (podem impactar performance)
‚úì Documente o prop√≥sito de cada trigger
‚úì Evite l√≥gica complexa em triggers
‚úì Cuidado com triggers que chamam outros triggers (cascata)
‚úì Teste triggers isoladamente
‚úì Use BEFORE para valida√ß√£o, AFTER para a√ß√µes
‚úì Considere alternativas (constraints, defaults)
‚úì Monitore performance de tabelas com muitos triggers

QUANDO N√ÉO USAR TRIGGERS:
‚ùå Para l√≥gica de neg√≥cio complexa ‚Üí use procedures
‚ùå Para valida√ß√µes simples ‚Üí use constraints CHECK
‚ùå Para valores padr√£o ‚Üí use DEFAULT
‚ùå Se impactar performance ‚Üí considere fazer na aplica√ß√£o

================================================================================
EXERC√çCIOS PR√ÅTICOS
================================================================================

EXERC√çCIO 1: Trigger de Valida√ß√£o [M√âDIO - 20 min]
Criar trigger que impede inserir cliente com email duplicado (case-insensitive).

--------------------------------------------------------------------------------

EXERC√çCIO 2: Hist√≥rico de Pre√ßos [M√âDIO - 25 min]
Criar tabela historico_precos e trigger que registra altera√ß√µes de pre√ßo
de produtos com: produto_id, preco_antigo, preco_novo, data_alteracao.

--------------------------------------------------------------------------------

EXERC√çCIO 3: Controle de Status [AVAN√áADO - 30 min]
Criar trigger que valida transi√ß√µes de status de pedido:
- PENDENTE ‚Üí PROCESSANDO ‚Üí CONFIRMADO ‚Üí ENTREGUE
- S√≥ pode ir para frente, nunca voltar (exceto CANCELADO)
- CANCELADO pode vir de qualquer status exceto ENTREGUE

--------------------------------------------------------------------------------

EXERC√çCIO 4: Sistema de Pontos [AVAN√áADO - 35 min]
Criar sistema de pontos:
1. Tabela clientes_pontos (cliente_id, pontos, nivel)
2. Trigger que adiciona 1 ponto a cada R$ 10 em pedidos
3. Trigger que atualiza n√≠vel: Bronze (0-100), Prata (101-500), Ouro (500+)
4. Tabela historico_pontos para auditoria

================================================================================
PROJETO PR√ÅTICO
================================================================================

Implementar sistema completo de auditoria e automa√ß√£o:

1. Triggers de auditoria para todas as tabelas principais
2. Controle autom√°tico de estoque (entrada/sa√≠da)
3. C√°lculo autom√°tico de totais
4. Valida√ß√µes de integridade
5. Notifica√ß√µes de eventos importantes
6. Hist√≥rico de altera√ß√µes de campos cr√≠ticos

DELIVERABLE: Script SQL com todos os triggers documentados

TAREFA: Implementar triggers no seu projeto | PR√ìXIMA AULA: Performance

================================================================================
FIM DA AULA 12
================================================================================
