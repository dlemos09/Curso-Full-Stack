================================================================================
                              AULA 04 - DIA 4
                    DML - MANIPULAÃ‡ÃƒO DE DADOS E TRANSAÃ‡Ã•ES
================================================================================

HORÃRIO: 13:30 - 17:30 (4 horas)
DATA: _____/_____/_____

================================================================================
                            OBJETIVOS DA AULA
================================================================================

Ao final desta aula, vocÃª serÃ¡ capaz de:
âœ“ Usar INSERT avanÃ§ado (RETURNING, ON CONFLICT)
âœ“ Executar UPDATE em mÃºltiplas tabelas
âœ“ Aplicar DELETE com subconsultas
âœ“ Controlar transaÃ§Ãµes (BEGIN, COMMIT, ROLLBACK)
âœ“ Entender ACID e nÃ­veis de isolamento

================================================================================
                          CRONOGRAMA DA AULA
================================================================================

13:30 - 13:45 (15 min) â†’ RevisÃ£o + Quiz
13:45 - 14:45 (60 min) â†’ INSERT e UPDATE AvanÃ§ados
14:45 - 15:30 (45 min) â†’ DELETE e OperaÃ§Ãµes em Lote
15:30 - 15:45 (15 min) â†’ â˜• INTERVALO
15:45 - 17:00 (75 min) â†’ TransaÃ§Ãµes (BEGIN, COMMIT, ROLLBACK)
17:00 - 17:30 (30 min) â†’ ExercÃ­cios PrÃ¡ticos

================================================================================
     PARTE 1: INSERT AVANÃ‡ADO (13:45 - 14:15)
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1.1 INSERT RETURNING - RETORNAR DADOS INSERIDOS                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- RETURNING retorna valores da linha inserida
INSERT INTO clientes (nome, email) 
VALUES ('JoÃ£o Silva', 'joao@email.com')
RETURNING id, nome, email;

/*
   Resultado:
    id â”‚    nome     â”‚      email
   â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     1 â”‚ JoÃ£o Silva  â”‚ joao@email.com
   
   ğŸ’¡ ÃšTIL PARA:
   - Saber qual ID foi gerado (SERIAL)
   - Confirmar valores com DEFAULT aplicado
   - Usar o ID retornado em prÃ³xima query
*/

-- Retornar mÃºltiplas linhas inseridas:
INSERT INTO produtos (nome, preco) VALUES
    ('Notebook', 3500.00),
    ('Mouse', 50.00),
    ('Teclado', 150.00)
RETURNING *;  -- * retorna todas as colunas


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1.2 INSERT com SELECT (Copiar dados)                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Copiar dados de outra tabela
CREATE TABLE produtos_backup (LIKE produtos INCLUDING ALL);

INSERT INTO produtos_backup
SELECT * FROM produtos WHERE estoque < 10;

-- Inserir resultado de cÃ¡lculo:
INSERT INTO relatorio_vendas (mes, total_vendas)
SELECT 
    EXTRACT(MONTH FROM data_venda) AS mes,
    SUM(valor_total) AS total
FROM pedidos
WHERE EXTRACT(YEAR FROM data_venda) = 2024
GROUP BY mes;


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1.3 ON CONFLICT - TRATAR DUPLICATAS (UPSERT)                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Tabela de exemplo:
CREATE TABLE estoque (
    produto_id INTEGER PRIMARY KEY,
    quantidade INTEGER DEFAULT 0
);

-- Se jÃ¡ existe, ATUALIZA; senÃ£o, INSERE:
INSERT INTO estoque (produto_id, quantidade) 
VALUES (1, 100)
ON CONFLICT (produto_id) 
DO UPDATE SET quantidade = estoque.quantidade + EXCLUDED.quantidade;

/*
   ğŸ“š EXPLICAÃ‡ÃƒO:
   - ON CONFLICT (produto_id) â†’ se produto_id jÃ¡ existe
   - DO UPDATE â†’ atualiza ao invÃ©s de dar erro
   - EXCLUDED.quantidade â†’ valor que tentou inserir
   
   Primeira vez: insere produto_id=1, quantidade=100
   Segunda vez: atualiza quantidade = 100 + 100 = 200
*/

-- Ignorar se jÃ¡ existe (DO NOTHING):
INSERT INTO clientes (email, nome) 
VALUES ('joao@email.com', 'JoÃ£o')
ON CONFLICT (email) DO NOTHING;


================================================================================
     PARTE 2: UPDATE AVANÃ‡ADO (14:15 - 14:45)
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2.1 UPDATE com EXPRESSÃ•ES                                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Atualizar com cÃ¡lculo:
UPDATE produtos 
SET preco = preco * 1.10  -- Aumentar 10%
WHERE categoria = 'EletrÃ´nicos';

-- Atualizar mÃºltiplas colunas:
UPDATE funcionarios 
SET 
    salario = salario * 1.05,
    data_ultimo_aumento = CURRENT_DATE
WHERE departamento_id = 1;

-- Atualizar com CASE (condiÃ§Ã£o):
UPDATE produtos
SET desconto = CASE
    WHEN preco > 1000 THEN 15.00
    WHEN preco > 500 THEN 10.00
    ELSE 5.00
END;


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2.2 UPDATE com FROM (Join)                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

-- Atualizar com dados de outra tabela:
UPDATE pedidos
SET cliente_nome = c.nome
FROM clientes c
WHERE pedidos.cliente_id = c.id;

-- Atualizar baseado em subconsulta:
UPDATE funcionarios
SET salario = salario * 1.10
WHERE departamento_id IN (
    SELECT id FROM departamentos 
    WHERE nome = 'TI'
);


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2.3 UPDATE RETURNING                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

-- Ver o que foi atualizado:
UPDATE produtos 
SET preco = preco * 0.90
WHERE estoque > 100
RETURNING id, nome, preco;


================================================================================
     PARTE 3: DELETE AVANÃ‡ADO (14:45 - 15:30)
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.1 DELETE com SUBCONSULTA                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

-- Deletar clientes sem pedidos:
DELETE FROM clientes
WHERE id NOT IN (
    SELECT DISTINCT cliente_id FROM pedidos
);

-- Deletar produtos sem vendas hÃ¡ mais de 1 ano:
DELETE FROM produtos
WHERE id NOT IN (
    SELECT DISTINCT produto_id 
    FROM itens_pedido ip
    JOIN pedidos p ON ip.pedido_id = p.id
    WHERE p.data_pedido > CURRENT_DATE - INTERVAL '1 year'
);


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.2 DELETE com USING (Join)                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Deletar pedidos de clientes inativos:
DELETE FROM pedidos
USING clientes
WHERE pedidos.cliente_id = clientes.id
  AND clientes.ativo = FALSE;


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.3 DELETE RETURNING                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Ver o que foi deletado (Ãºtil para auditoria):
DELETE FROM produtos 
WHERE estoque = 0
RETURNING id, nome, data_cadastro;


================================================================================
     PARTE 4: TRANSAÃ‡Ã•ES (15:45 - 17:00)
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 4.1 O QUE Ã‰ UMA TRANSAÃ‡ÃƒO?                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ DEFINIÃ‡ÃƒO:
   TransaÃ§Ã£o Ã© um conjunto de operaÃ§Ãµes que sÃ£o executadas como uma
   unidade indivisÃ­vel: ou TODAS acontecem, ou NENHUMA acontece.

ğŸ“Œ PROPRIEDADES ACID:

   ğŸ…°ï¸ ATOMICITY (Atomicidade)
      Tudo ou nada. Se uma parte falha, TUDO Ã© desfeito.
   
   ğŸ…² CONSISTENCY (ConsistÃªncia)
      Dados sempre vÃ¡lidos (respeitam constraints).
   
   ğŸ…¸ ISOLATION (Isolamento)
      TransaÃ§Ãµes concorrentes nÃ£o interferem.
   
   ğŸ…³ DURABILITY (Durabilidade)
      Dados persistem apÃ³s COMMIT.

ğŸ“Œ EXEMPLO DO MUNDO REAL:
   TransferÃªncia bancÃ¡ria: debitar conta A e creditar conta B
   - Se debitar A mas der erro ao creditar B â†’ ROLLBACK!
   - Ambas devem acontecer juntas


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 4.2 COMANDOS DE TRANSAÃ‡ÃƒO                                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEGIN;     -- Inicia transaÃ§Ã£o
-- ... comandos SQL ...
COMMIT;    -- Confirma mudanÃ§as (torna permanente)

-- ou

BEGIN;
-- ... comandos SQL ...
ROLLBACK;  -- Desfaz tudo (volta ao estado anterior)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 4.3 EXEMPLO PRÃTICO - TRANSFERÃŠNCIA BANCÃRIA                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE contas (
    id SERIAL PRIMARY KEY,
    titular VARCHAR(100),
    saldo DECIMAL(10,2) CHECK (saldo >= 0)
);

INSERT INTO contas (titular, saldo) VALUES
    ('JoÃ£o', 1000.00),
    ('Maria', 500.00);

-- âœ… TRANSFERÃŠNCIA COM SUCESSO:
BEGIN;
    -- Debitar de JoÃ£o:
    UPDATE contas SET saldo = saldo - 200 WHERE titular = 'JoÃ£o';
    
    -- Creditar para Maria:
    UPDATE contas SET saldo = saldo + 200 WHERE titular = 'Maria';
COMMIT;  -- Confirma as duas operaÃ§Ãµes

SELECT * FROM contas;
-- JoÃ£o: 800.00
-- Maria: 700.00


-- âŒ TRANSFERÃŠNCIA COM ERRO - ROLLBACK AUTOMÃTICO:
BEGIN;
    UPDATE contas SET saldo = saldo - 500 WHERE titular = 'JoÃ£o';
    -- JoÃ£o agora teria 300.00
    
    -- Tenta creditar valor errado (violaria CHECK):
    UPDATE contas SET saldo = saldo - 1000 WHERE titular = 'Maria';
    -- ERROR! saldo nÃ£o pode ser negativo
ROLLBACK;  -- Desfaz TUDO

SELECT * FROM contas;
-- JoÃ£o: 800.00 (voltou ao estado anterior!)
-- Maria: 700.00


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 4.4 SAVEPOINT - PONTOS DE SALVAMENTO                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEGIN;
    INSERT INTO produtos (nome, preco) VALUES ('Produto A', 100);
    
    SAVEPOINT ponto1;  -- Marca ponto de salvamento
    
    INSERT INTO produtos (nome, preco) VALUES ('Produto B', 200);
    
    SAVEPOINT ponto2;
    
    INSERT INTO produtos (nome, preco) VALUES ('Produto C', 300);
    
    -- Ops, erro no Produto C, voltar para ponto2:
    ROLLBACK TO ponto2;
    -- Produto C foi desfeito, A e B permanecem
    
    -- Ou voltar para ponto1:
    ROLLBACK TO ponto1;
    -- B e C desfeitos, apenas A permanece
    
COMMIT;  -- Confirma apenas Produto A

/*
   ğŸ’¡ SAVEPOINT Ã© Ãºtil para:
   - Desfazer parte da transaÃ§Ã£o
   - Processos longos com mÃºltiplas etapas
   - Permitir erro em sub-operaÃ§Ã£o sem perder tudo
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 4.5 TRANSAÃ‡Ã•ES IMPLÃCITAS vs EXPLÃCITAS                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- IMPLÃCITA (auto-commit):
INSERT INTO produtos (nome) VALUES ('Teste');
-- Automaticamente faz BEGIN + COMMIT

-- EXPLÃCITA:
BEGIN;
    INSERT INTO produtos (nome) VALUES ('Teste 1');
    INSERT INTO produtos (nome) VALUES ('Teste 2');
COMMIT;  -- VocÃª controla quando confirmar

/*
   ğŸ’¡ QUANDO USAR TRANSAÃ‡Ã•ES EXPLÃCITAS:
   - MÃºltiplas operaÃ§Ãµes relacionadas
   - OperaÃ§Ãµes que devem ser atÃ´micas
   - ImportaÃ§Ã£o de dados em lote
   - AlteraÃ§Ãµes crÃ­ticas (teste antes de COMMIT)
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 4.6 NÃVEIS DE ISOLAMENTO (AvanÃ§ado)                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- PostgreSQL suporta 4 nÃ­veis de isolamento:

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  -- PadrÃ£o
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

/*
   ğŸ“Š PROBLEMAS DE CONCORRÃŠNCIA:
   
   DIRTY READ: Ler dados nÃ£o confirmados de outra transaÃ§Ã£o
   NON-REPEATABLE READ: Ler duas vezes, valores diferentes
   PHANTOM READ: Linhas aparecem/somem entre leituras
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ NÃ­vel            â”‚ Dirty  â”‚ Non-Repeat. â”‚ Phantom     â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ READ UNCOMMITTED â”‚ Sim    â”‚ Sim         â”‚ Sim         â”‚
   â”‚ READ COMMITTED   â”‚ NÃ£o    â”‚ Sim         â”‚ Sim         â”‚
   â”‚ REPEATABLE READ  â”‚ NÃ£o    â”‚ NÃ£o         â”‚ Sim*        â”‚
   â”‚ SERIALIZABLE     â”‚ NÃ£o    â”‚ NÃ£o         â”‚ NÃ£o         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   *No PostgreSQL, REPEATABLE READ evita phantom reads tambÃ©m
   
   ğŸ’¡ REGRA GERAL:
   Quanto maior o isolamento, menor a performance
   Use READ COMMITTED (padrÃ£o) para 99% dos casos
*/


================================================================================
                    EXERCÃCIOS PRÃTICOS (17:00 - 17:30)
================================================================================

ğŸ’ª EXERCÃCIO 1: UPSERT (10 min)

Crie uma tabela "visitas_site":
- pagina VARCHAR(100) PRIMARY KEY
- contador INTEGER DEFAULT 0

Use ON CONFLICT para:
- Se pÃ¡gina jÃ¡ existe: incrementar contador
- Se nÃ£o existe: inserir com contador = 1

Teste inserindo a mesma pÃ¡gina 3 vezes.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’ª EXERCÃCIO 2: UPDATE EM LOTE (10 min)

Dada a tabela "produtos":
a) Aumentar 15% no preÃ§o de produtos da categoria 'EletrÃ´nicos'
b) Diminuir 10% no preÃ§o de produtos com estoque > 100
c) Zerar desconto de produtos inativos
d) Use RETURNING para ver o que foi alterado

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’ª EXERCÃCIO 3: LIMPEZA DE DADOS (10 min)

a) Delete clientes que:
   - EstÃ£o inativos E
   - NÃ£o tÃªm pedidos nos Ãºltimos 2 anos
   
b) Delete produtos com:
   - Estoque = 0 E
   - Sem vendas (nÃ£o estÃ£o em itens_pedido)

c) Use RETURNING para registrar o que foi deletado

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’ª EXERCÃCIO 4: TRANSAÃ‡ÃƒO - SISTEMA DE PEDIDOS (20 min)

Crie uma transaÃ§Ã£o que:

1. Inserir pedido na tabela "pedidos"
2. Inserir 3 itens na tabela "itens_pedido"
3. Atualizar estoque dos produtos (subtrair quantidade vendida)
4. Se qualquer produto ficar com estoque negativo â†’ ROLLBACK

Teste com:
a) Estoque suficiente (deve dar COMMIT)
b) Estoque insuficiente (deve dar ROLLBACK)

DICA: Use CHECK (estoque >= 0) na tabela produtos

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’ª DESAFIO EXTRA: AUDITORIA

Crie uma tabela "log_alteracoes":
- id, tabela_nome, operacao ('INSERT', 'UPDATE', 'DELETE'),
  usuario, data_hora, dados_json

FaÃ§a uma transaÃ§Ã£o que:
1. Atualiza salÃ¡rio de funcionÃ¡rio
2. Registra a alteraÃ§Ã£o no log
3. COMMIT apenas se ambas funcionarem


================================================================================
                              RESUMO DA AULA
================================================================================

âœ… O QUE APRENDEMOS:

   INSERT AVANÃ‡ADO:
   â€¢ RETURNING â†’ retorna dados inseridos
   â€¢ INSERT ... SELECT â†’ copiar dados
   â€¢ ON CONFLICT â†’ tratar duplicatas (upsert)

   UPDATE AVANÃ‡ADO:
   â€¢ Com expressÃµes e cÃ¡lculos
   â€¢ Com FROM (join)
   â€¢ RETURNING

   DELETE AVANÃ‡ADO:
   â€¢ Com subconsultas
   â€¢ Com USING (join)
   â€¢ RETURNING

   TRANSAÃ‡Ã•ES:
   â€¢ BEGIN, COMMIT, ROLLBACK
   â€¢ SAVEPOINT â†’ pontos de salvamento
   â€¢ ACID â†’ Atomicidade, ConsistÃªncia, Isolamento, Durabilidade
   â€¢ NÃ­veis de isolamento

ğŸ“š TAREFA PARA CASA:
   1. ExercÃ­cios 31-40 da lista geral
   2. Praticar transaÃ§Ãµes com cenÃ¡rios reais
   3. Ler sobre locks e concorrÃªncia

ğŸ”œ PRÃ“XIMA AULA:
   Consultas BÃ¡sicas e Filtros
   - WHERE com operadores complexos
   - LIKE, ILIKE, padrÃµes
   - IN, BETWEEN, IS NULL
   - ORDER BY, LIMIT, OFFSET (paginaÃ§Ã£o)

================================================================================
                            FIM DA AULA 04
================================================================================
