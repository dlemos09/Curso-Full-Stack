================================================================================
                              AULA 15 - DIA 15
                   PROJETO FINAL E AVALIA√á√ÉO DO CURSO
================================================================================

HOR√ÅRIO: 13:30 - 17:30 | DATA: _____/_____/_____

OBJETIVOS:
‚úì Desenvolver projeto integrado completo
‚úì Demonstrar dom√≠nio de todos os conceitos
‚úì Aplicar boas pr√°ticas
‚úì Apresentar solu√ß√£o t√©cnica

CRONOGRAMA:
13:30-13:45 ‚Üí Apresenta√ß√£o do Projeto Final
13:45-15:30 ‚Üí Desenvolvimento
15:30-15:45 ‚Üí Intervalo
15:45-17:00 ‚Üí Finaliza√ß√£o
17:00-17:30 ‚Üí Apresenta√ß√µes e Encerramento

================================================================================
PROJETO FINAL: SISTEMA DE BIBLIOTECA COMPLETO
================================================================================

DESCRI√á√ÉO:
Desenvolver sistema de gerenciamento de biblioteca com empr√©stimos, multas,
reservas e controle de usu√°rios.

REQUISITOS OBRIGAT√ìRIOS:
‚ñ° Modelagem ER completa
‚ñ° M√≠nimo 10 tabelas relacionadas
‚ñ° Constraints apropriadas
‚ñ° Triggers para automa√ß√£o
‚ñ° Functions/Procedures
‚ñ° Views materializadas
‚ñ° √çndices otimizados
‚ñ° Sistema de seguran√ßa (roles/RLS)
‚ñ° Script de backup
‚ñ° Documenta√ß√£o completa

================================================================================
1. ESPECIFICA√á√ÉO DO SISTEMA
================================================================================

ENTIDADES PRINCIPAIS:
1. Livros (t√≠tulo, ISBN, editora, ano, categoria, quantidade)
2. Autores (nome, nacionalidade, biografia)
3. Livro_Autores (relacionamento N:N)
4. Categorias (fic√ß√£o, t√©cnico, biografia, etc.)
5. Usu√°rios (nome, CPF, email, telefone, tipo)
6. Empr√©stimos (usu√°rio, livro, data_emprestimo, data_devolucao)
7. Reservas (usu√°rio, livro, data_reserva, status)
8. Multas (empr√©stimo, valor, pago)
9. Funcion√°rios (bibliotec√°rios, administradores)
10. Hist√≥rico (auditoria de opera√ß√µes)

REGRAS DE NEG√ìCIO:
- Usu√°rio comum: at√© 3 livros simult√¢neos
- Usu√°rio premium: at√© 5 livros simult√¢neos
- Prazo empr√©stimo: 14 dias
- Multa: R$ 2,00/dia de atraso
- Reserva: v√°lida por 48h ap√≥s disponibilidade
- Livro pode ter m√∫ltiplos autores
- Renova√ß√£o: m√°ximo 2 vezes se n√£o houver reservas
- Suspens√£o: usu√°rio com multa > R$ 20,00

================================================================================
2. DESENVOLVIMENTO PASSO A PASSO
================================================================================

ETAPA 1: MODELAGEM E CRIA√á√ÉO (45 min)
--------------------------------------------------------------------------------

-- Database e extensions
CREATE DATABASE biblioteca;
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Schema para organiza√ß√£o
CREATE SCHEMA IF NOT EXISTS biblioteca;
SET search_path TO biblioteca, public;

-- Exemplo de tabela (criar todas!)
CREATE TABLE categorias (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE,
    descricao TEXT,
    ativa BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE livros (
    id SERIAL PRIMARY KEY,
    titulo VARCHAR(300) NOT NULL,
    isbn VARCHAR(17) UNIQUE,
    editora VARCHAR(200),
    ano_publicacao INTEGER CHECK (ano_publicacao > 1400),
    categoria_id INTEGER REFERENCES categorias(id),
    quantidade_total INTEGER DEFAULT 1 CHECK (quantidade_total >= 0),
    quantidade_disponivel INTEGER DEFAULT 1 CHECK (quantidade_disponivel >= 0),
    localizacao VARCHAR(50),  -- estante
    sinopse TEXT,
    capa_url VARCHAR(500),
    ativo BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- üí° Criar todas as outras tabelas com relacionamentos corretos

--------------------------------------------------------------------------------
ETAPA 2: TRIGGERS (30 min)
--------------------------------------------------------------------------------

-- 1. Atualizar quantidade dispon√≠vel ao emprestar
CREATE OR REPLACE FUNCTION atualizar_disponibilidade_livro()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE livros 
        SET quantidade_disponivel = quantidade_disponivel - 1
        WHERE id = NEW.livro_id;
        
        IF (SELECT quantidade_disponivel FROM livros WHERE id = NEW.livro_id) < 0 THEN
            RAISE EXCEPTION 'Livro indispon√≠vel para empr√©stimo';
        END IF;
    ELSIF TG_OP = 'UPDATE' AND NEW.devolvido = TRUE AND OLD.devolvido = FALSE THEN
        UPDATE livros 
        SET quantidade_disponivel = quantidade_disponivel + 1
        WHERE id = NEW.livro_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_disponibilidade_livro
AFTER INSERT OR UPDATE ON emprestimos
FOR EACH ROW
EXECUTE FUNCTION atualizar_disponibilidade_livro();

-- 2. Calcular multa automaticamente
CREATE OR REPLACE FUNCTION calcular_multa()
RETURNS TRIGGER AS $$
DECLARE
    v_dias_atraso INTEGER;
    v_valor_multa DECIMAL;
BEGIN
    IF NEW.data_devolucao_real IS NOT NULL AND 
       NEW.data_devolucao_prevista < NEW.data_devolucao_real THEN
        
        v_dias_atraso := NEW.data_devolucao_real::DATE - NEW.data_devolucao_prevista::DATE;
        v_valor_multa := v_dias_atraso * 2.00;
        
        INSERT INTO multas (emprestimo_id, valor, pago)
        VALUES (NEW.id, v_valor_multa, FALSE);
        
        RAISE NOTICE 'Multa de R$ % gerada para empr√©stimo %', v_valor_multa, NEW.id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_calcular_multa
AFTER UPDATE ON emprestimos
FOR EACH ROW
WHEN (NEW.data_devolucao_real IS NOT NULL)
EXECUTE FUNCTION calcular_multa();

-- 3. Validar limite de empr√©stimos por tipo de usu√°rio
-- 4. Processar reservas quando livro devolvido
-- 5. Auditoria completa
-- üí° Implementar todos os triggers necess√°rios

--------------------------------------------------------------------------------
ETAPA 3: FUNCTIONS E PROCEDURES (30 min)
--------------------------------------------------------------------------------

-- Function: Verificar disponibilidade
CREATE OR REPLACE FUNCTION verificar_disponibilidade(p_livro_id INTEGER)
RETURNS TABLE(
    disponivel BOOLEAN,
    quantidade INTEGER,
    proxima_devolucao DATE
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        (l.quantidade_disponivel > 0) AS disponivel,
        l.quantidade_disponivel,
        (SELECT MIN(data_devolucao_prevista::DATE)
         FROM emprestimos 
         WHERE livro_id = p_livro_id AND devolvido = FALSE) AS proxima_devolucao
    FROM livros l
    WHERE l.id = p_livro_id;
END;
$$ LANGUAGE plpgsql;

-- Procedure: Realizar empr√©stimo completo
CREATE OR REPLACE PROCEDURE realizar_emprestimo(
    p_usuario_id INTEGER,
    p_livro_id INTEGER,
    p_funcionario_id INTEGER
) AS $$
DECLARE
    v_emprestimos_ativos INTEGER;
    v_tipo_usuario VARCHAR;
    v_limite INTEGER;
    v_multas_pendentes DECIMAL;
BEGIN
    -- Verificar multas pendentes
    SELECT COALESCE(SUM(valor), 0) INTO v_multas_pendentes
    FROM multas m
    JOIN emprestimos e ON m.emprestimo_id = e.id
    WHERE e.usuario_id = p_usuario_id AND m.pago = FALSE;
    
    IF v_multas_pendentes > 20.00 THEN
        RAISE EXCEPTION 'Usu√°rio suspenso por multas pendentes: R$ %', v_multas_pendentes;
    END IF;
    
    -- Verificar limite de empr√©stimos
    SELECT tipo INTO v_tipo_usuario FROM usuarios WHERE id = p_usuario_id;
    v_limite := CASE v_tipo_usuario 
        WHEN 'PREMIUM' THEN 5 
        ELSE 3 
    END;
    
    SELECT COUNT(*) INTO v_emprestimos_ativos
    FROM emprestimos 
    WHERE usuario_id = p_usuario_id AND devolvido = FALSE;
    
    IF v_emprestimos_ativos >= v_limite THEN
        RAISE EXCEPTION 'Limite de % empr√©stimos atingido', v_limite;
    END IF;
    
    -- Criar empr√©stimo
    INSERT INTO emprestimos (usuario_id, livro_id, funcionario_id, data_devolucao_prevista)
    VALUES (p_usuario_id, p_livro_id, p_funcionario_id, CURRENT_DATE + INTERVAL '14 days');
    
    RAISE NOTICE 'Empr√©stimo realizado com sucesso!';
END;
$$ LANGUAGE plpgsql;

-- Function: Relat√≥rio de livros mais emprestados
-- Function: Calcular total de multas de usu√°rio
-- Procedure: Processar devolu√ß√£o
-- Procedure: Renovar empr√©stimo
-- üí° Criar todas functions/procedures necess√°rias

--------------------------------------------------------------------------------
ETAPA 4: VIEWS (20 min)
--------------------------------------------------------------------------------

-- View: Empr√©stimos ativos com informa√ß√µes completas
CREATE OR REPLACE VIEW vw_emprestimos_ativos AS
SELECT 
    e.id,
    u.nome AS usuario,
    l.titulo AS livro,
    e.data_emprestimo,
    e.data_devolucao_prevista,
    CASE 
        WHEN e.data_devolucao_prevista < CURRENT_DATE THEN 
            CURRENT_DATE - e.data_devolucao_prevista::DATE
        ELSE 0
    END AS dias_atraso,
    f.nome AS atendente
FROM emprestimos e
JOIN usuarios u ON e.usuario_id = u.id
JOIN livros l ON e.livro_id = l.id
JOIN funcionarios f ON e.funcionario_id = f.id
WHERE e.devolvido = FALSE;

-- Materialized View: Estat√≠sticas de biblioteca
CREATE MATERIALIZED VIEW mv_estatisticas AS
SELECT 
    (SELECT COUNT(*) FROM livros WHERE ativo = TRUE) AS total_livros,
    (SELECT SUM(quantidade_total) FROM livros WHERE ativo = TRUE) AS total_exemplares,
    (SELECT COUNT(*) FROM usuarios WHERE ativo = TRUE) AS total_usuarios,
    (SELECT COUNT(*) FROM emprestimos WHERE devolvido = FALSE) AS emprestimos_ativos,
    (SELECT COUNT(*) FROM reservas WHERE status = 'ATIVA') AS reservas_ativas,
    (SELECT COALESCE(SUM(valor), 0) FROM multas WHERE pago = FALSE) AS multas_pendentes;

-- View: Livros dispon√≠veis com detalhes
-- View: Usu√°rios com multas
-- View: Ranking de livros mais emprestados
-- üí° Criar views √∫teis para relat√≥rios

--------------------------------------------------------------------------------
ETAPA 5: √çNDICES (15 min)
--------------------------------------------------------------------------------

-- √çndices para performance
CREATE INDEX idx_livros_categoria ON livros(categoria_id);
CREATE INDEX idx_livros_isbn ON livros(isbn);
CREATE INDEX idx_emprestimos_usuario ON emprestimos(usuario_id);
CREATE INDEX idx_emprestimos_livro ON emprestimos(livro_id);
CREATE INDEX idx_emprestimos_devolucao ON emprestimos(data_devolucao_prevista) 
    WHERE devolvido = FALSE;

-- √çndice funcional
CREATE INDEX idx_usuarios_email_lower ON usuarios(LOWER(email));

-- √çndice composto
CREATE INDEX idx_emprestimos_usuario_ativo ON emprestimos(usuario_id, devolvido);

-- üí° Criar √≠ndices estrat√©gicos baseados em queries frequentes

--------------------------------------------------------------------------------
ETAPA 6: SEGURAN√áA (25 min)
--------------------------------------------------------------------------------

-- Roles
CREATE ROLE biblioteca_readonly;
CREATE ROLE biblioteca_bibliotecario;
CREATE ROLE biblioteca_admin;

-- Permiss√µes readonly
GRANT CONNECT ON DATABASE biblioteca TO biblioteca_readonly;
GRANT USAGE ON SCHEMA biblioteca TO biblioteca_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA biblioteca TO biblioteca_readonly;

-- Permiss√µes bibliotec√°rio
GRANT biblioteca_readonly TO biblioteca_bibliotecario;
GRANT INSERT, UPDATE ON emprestimos, reservas TO biblioteca_bibliotecario;
GRANT INSERT ON multas TO biblioteca_bibliotecario;

-- Row Level Security
ALTER TABLE emprestimos ENABLE ROW LEVEL SECURITY;

CREATE POLICY usuario_ve_proprios_emprestimos ON emprestimos
    FOR SELECT
    TO biblioteca_readonly
    USING (usuario_id = (SELECT id FROM usuarios WHERE email = CURRENT_USER));

-- üí° Implementar RLS e permiss√µes completas

--------------------------------------------------------------------------------
ETAPA 7: DADOS DE TESTE (20 min)
--------------------------------------------------------------------------------

-- Popular com dados realistas
INSERT INTO categorias (nome) VALUES
    ('Fic√ß√£o'), ('T√©cnico'), ('Biografia'), ('Hist√≥ria'), ('Ci√™ncia');

-- Inserir livros, autores, usu√°rios, etc.
-- Criar pelo menos:
-- - 50 livros
-- - 20 autores
-- - 30 usu√°rios
-- - 40 empr√©stimos (alguns em atraso)
-- - 15 reservas
-- üí° Dados devem permitir testar todas as funcionalidades

================================================================================
3. QUERIES OBRIGAT√ìRIAS
================================================================================

Desenvolver queries para:

1. RELAT√ìRIOS:
   a) Livros mais emprestados (top 10)
   b) Usu√°rios com mais empr√©stimos
   c) Livros nunca emprestados
   d) Empr√©stimos em atraso com multas calculadas
   e) Receita total de multas por m√™s

2. AN√ÅLISES:
   a) Taxa de ocupa√ß√£o da biblioteca (emprestados/total)
   b) Tempo m√©dio de empr√©stimo por categoria
   c) Autores mais populares
   d) Usu√°rios inadimplentes

3. DASHBOARD:
   Query √∫nica que retorna m√©tricas principais do dia/m√™s

4. COMPLEXAS:
   a) Livros dispon√≠veis de autores com mais de 3 livros cadastrados
   b) Usu√°rios eleg√≠veis para upgrade (premium)
   c) Proje√ß√£o de devolu√ß√µes pr√≥ximos 7 dias
   d) Ranking de categorias por popularidade com CTE

================================================================================
4. DOCUMENTA√á√ÉO OBRIGAT√ìRIA
================================================================================

Criar arquivo DOCUMENTACAO.txt com:

1. MODELAGEM:
   - Diagrama ER (descri√ß√£o textual)
   - Explica√ß√£o dos relacionamentos
   - Justificativa de constraints

2. TRIGGERS:
   - Lista de triggers criados
   - Prop√≥sito de cada um
   - Eventos que disparam

3. FUNCTIONS/PROCEDURES:
   - Lista com descri√ß√£o
   - Par√¢metros e retornos
   - Exemplos de uso

4. √çNDICES:
   - Lista de √≠ndices
   - Justificativa t√©cnica
   - Queries que beneficiam

5. SEGURAN√áA:
   - Estrutura de roles
   - Pol√≠ticas de RLS
   - Recomenda√ß√µes

6. BACKUP:
   - Script de backup
   - Frequ√™ncia recomendada
   - Procedimento de restore

7. QUERIES:
   - Todas as queries obrigat√≥rias
   - EXPLAIN de queries complexas

================================================================================
5. ENTREGA FINAL
================================================================================

ARQUIVOS:
1. biblioteca_completo.sql ‚Üí Script com toda estrutura e dados
2. queries_relatorios.sql ‚Üí Todas as queries obrigat√≥rias
3. DOCUMENTACAO.txt ‚Üí Documenta√ß√£o completa
4. backup_script.ps1 ‚Üí Script de backup automatizado (opcional)

CRIT√âRIOS DE AVALIA√á√ÉO (100 pontos):

‚ñ° Modelagem (15 pontos)
  - Relacionamentos corretos
  - Constraints apropriadas
  - Normaliza√ß√£o

‚ñ° Implementa√ß√£o (25 pontos)
  - C√≥digo funcionando sem erros
  - Dados de teste adequados
  - Organiza√ß√£o do c√≥digo

‚ñ° Triggers (15 pontos)
  - Automa√ß√£o de regras
  - Tratamento de erros
  - Efici√™ncia

‚ñ° Functions/Procedures (10 pontos)
  - Funcionalidades √∫teis
  - Par√¢metros corretos
  - Reutiliz√°veis

‚ñ° Views e √çndices (10 pontos)
  - Views √∫teis
  - √çndices estrat√©gicos
  - Performance

‚ñ° Seguran√ßa (10 pontos)
  - Roles bem definidos
  - RLS implementado
  - Boas pr√°ticas

‚ñ° Queries (10 pontos)
  - Todas obrigat√≥rias
  - Otimizadas
  - Resultados corretos

‚ñ° Documenta√ß√£o (5 pontos)
  - Completa
  - Clara
  - Profissional

B√îNUS (at√© 20 pontos):
+ Funcionalidades extras
+ Interface para relat√≥rios
+ Testes unit√°rios
+ Sistema de notifica√ß√µes
+ Backup automatizado

================================================================================
6. DICAS PARA SUCESSO
================================================================================

‚úì Comece pela modelagem (desenhe no papel)
‚úì Teste cada parte antes de continuar
‚úì Use transa√ß√µes para popular dados
‚úì Comente c√≥digo adequadamente
‚úì Execute EXPLAIN em queries complexas
‚úì Verifique constraints funcionando
‚úì Teste triggers com dados variados
‚úì Documente conforme desenvolve
‚úì Organize c√≥digo com separadores
‚úì Fa√ßa backup antes de grandes mudan√ßas

================================================================================
7. REVIS√ÉO DO CURSO
================================================================================

DIA 1-2: Fundamentos (DDL, tipos, constraints)
DIA 3-4: Relacionamentos e DML
DIA 5: Consultas e filtros
DIA 6: JOINs
DIA 7: Agrega√ß√µes
DIA 8: Subconsultas e CTEs
DIA 9: Views e √çndices
DIA 10: Projeto Pr√°tico 1
DIA 11: Functions e Procedures
DIA 12: Triggers
DIA 13: Performance
DIA 14: Administra√ß√£o e Seguran√ßa
DIA 15: PROJETO FINAL (hoje)

PARAB√âNS POR CHEGAR AT√â AQUI!

================================================================================
ENCERRAMENTO
================================================================================

Voc√™ agora possui conhecimento s√≥lido em:
‚úì Modelagem de dados
‚úì SQL (DDL, DML, DQL)
‚úì JOINs e agrega√ß√µes
‚úì Subconsultas e CTEs
‚úì Views e √≠ndices
‚úì Triggers e automa√ß√£o
‚úì Functions e procedures
‚úì Otimiza√ß√£o de performance
‚úì Seguran√ßa e administra√ß√£o
‚úì Backup e restore

PR√ìXIMOS PASSOS:
- Praticar com projetos reais
- Estudar PostgreSQL avan√ßado (particionamento, replica√ß√£o)
- Aprender outros SGBDs (MySQL, SQL Server, Oracle)
- Explorar NoSQL (MongoDB, Redis)
- Integrar banco com aplica√ß√µes (Python, Java, etc.)

BOA SORTE NO SEU PROJETO FINAL E NA SUA CARREIRA COM BANCOS DE DADOS!

================================================================================
FIM DO CURSO - OBRIGADO!
================================================================================
