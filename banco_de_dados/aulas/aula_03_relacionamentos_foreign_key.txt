================================================================================
                              AULA 03 - DIA 3
            DDL AVANÃ‡ADO - RELACIONAMENTOS E CHAVES ESTRANGEIRAS
================================================================================

HORÃRIO: 13:30 - 17:30 (4 horas)
DATA: _____/_____/_____

================================================================================
                            OBJETIVOS DA AULA
================================================================================

Ao final desta aula, vocÃª serÃ¡ capaz de:
âœ“ Criar relacionamentos entre tabelas com FOREIGN KEY
âœ“ Compreender integridade referencial
âœ“ Usar ON DELETE e ON UPDATE (CASCADE, SET NULL, RESTRICT)
âœ“ Modificar tabelas existentes com ALTER TABLE
âœ“ Usar DROP e TRUNCATE corretamente

================================================================================
                          CRONOGRAMA DA AULA
================================================================================

13:30 - 13:45 (15 min) â†’ RevisÃ£o + Quiz
13:45 - 14:45 (60 min) â†’ Chaves Estrangeiras e Relacionamentos
14:45 - 15:30 (45 min) â†’ ON DELETE / ON UPDATE
15:30 - 15:45 (15 min) â†’ â˜• INTERVALO
15:45 - 17:00 (75 min) â†’ ALTER TABLE - Modificar Estruturas
17:00 - 17:30 (30 min) â†’ ExercÃ­cios PrÃ¡ticos

================================================================================
     PARTE 1: CHAVES ESTRANGEIRAS (13:45 - 14:45)
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1.1 O QUE SÃƒO CHAVES ESTRANGEIRAS (FOREIGN KEY)?                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ DEFINIÃ‡ÃƒO:
   Uma FOREIGN KEY (FK) Ã© uma coluna que referencia a PRIMARY KEY de outra 
   tabela, criando um relacionamento entre elas.

ğŸ“Œ PROPÃ“SITO:
   - Garantir integridade referencial (dados consistentes)
   - Evitar "Ã³rfÃ£os" (registros que referenciam IDs inexistentes)
   - Modelar relacionamentos do mundo real

ğŸ“Œ ANALOGIA:
   Pense em um livro de biblioteca e seu autor:
   - Cada livro TEM um autor (relacionamento)
   - O autor_id no livro APONTA para um id real na tabela autores
   - NÃ£o pode cadastrar livro com autor_id = 999 se autor 999 nÃ£o existe!


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1.2 CRIANDO RELACIONAMENTO 1:N (UM PARA MUITOS)                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Exemplo: Um departamento TEM muitos funcionÃ¡rios
--          Um funcionÃ¡rio PERTENCE a um departamento

-- PASSO 1: Criar tabela "pai" (lado 1)
CREATE TABLE departamentos (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(50) NOT NULL UNIQUE,
    sigla VARCHAR(5),
    ativo BOOLEAN DEFAULT TRUE
);

-- PASSO 2: Criar tabela "filho" (lado N) com FK
CREATE TABLE funcionarios (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    cpf CHAR(11) UNIQUE NOT NULL,
    salario DECIMAL(10,2),
    departamento_id INTEGER NOT NULL,
    
    -- Definir chave estrangeira:
    FOREIGN KEY (departamento_id) REFERENCES departamentos(id)
);

/*
   ğŸ“š EXPLICAÃ‡ÃƒO:
   
   FOREIGN KEY (departamento_id)    â†’ Coluna que Ã© FK
   REFERENCES departamentos(id)     â†’ Aponta para qual tabela(coluna)
   
   REGRA CRIADA:
   âœ“ departamento_id deve existir em departamentos.id
   âŒ NÃ£o pode inserir funcionÃ¡rio com departamento_id inexistente
*/

-- Inserindo dados (ordem importa!):
-- 1Âº) Inserir na tabela pai (departamentos)
INSERT INTO departamentos (nome, sigla) VALUES
    ('Tecnologia da InformaÃ§Ã£o', 'TI'),
    ('Recursos Humanos', 'RH'),
    ('Financeiro', 'FIN');

-- 2Âº) Inserir na tabela filho (funcionarios)
-- âœ… VÃ¡lido - departamento 1 existe:
INSERT INTO funcionarios (nome, cpf, salario, departamento_id) 
VALUES ('JoÃ£o Silva', '12345678901', 5000.00, 1);

-- âŒ ERRO - departamento 99 nÃ£o existe:
-- INSERT INTO funcionarios (nome, cpf, salario, departamento_id) 
-- VALUES ('Maria Santos', '98765432100', 4500.00, 99);
-- ERROR: insert or update violates foreign key constraint


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1.3 SINTAXES DE FOREIGN KEY                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- FORMA 1: Inline (na prÃ³pria coluna)
CREATE TABLE pedidos (
    id SERIAL PRIMARY KEY,
    cliente_id INTEGER REFERENCES clientes(id),
    data_pedido DATE
);

-- FORMA 2: Como constraint separada (mais legÃ­vel)
CREATE TABLE itens_pedido (
    id SERIAL PRIMARY KEY,
    pedido_id INTEGER,
    produto_id INTEGER,
    quantidade INTEGER,
    
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id),
    FOREIGN KEY (produto_id) REFERENCES produtos(id)
);

-- FORMA 3: Com nome de constraint (facilita manutenÃ§Ã£o)
CREATE TABLE avaliacoes (
    id SERIAL PRIMARY KEY,
    produto_id INTEGER,
    usuario_id INTEGER,
    nota INTEGER CHECK (nota BETWEEN 1 AND 5),
    
    CONSTRAINT fk_avaliacoes_produto 
        FOREIGN KEY (produto_id) REFERENCES produtos(id),
    
    CONSTRAINT fk_avaliacoes_usuario 
        FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

/*
   ğŸ’¡ BENEFÃCIO DE NOMEAR CONSTRAINTS:
   - Mensagens de erro mais claras
   - FÃ¡cil identificar qual FK tem problema
   - Facilita alterar/remover depois
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 1.4 RELACIONAMENTO N:N (MUITOS PARA MUITOS) - TABELA ASSOCIATIVA          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Exemplo: Alunos cursam VÃRIAS disciplinas
--          Disciplinas tÃªm VÃRIOS alunos

-- Tabela 1
CREATE TABLE alunos (
    id SERIAL PRIMARY KEY,
    matricula VARCHAR(10) UNIQUE NOT NULL,
    nome VARCHAR(100) NOT NULL
);

-- Tabela 2
CREATE TABLE disciplinas (
    id SERIAL PRIMARY KEY,
    codigo VARCHAR(10) UNIQUE NOT NULL,
    nome VARCHAR(100) NOT NULL,
    carga_horaria INTEGER
);

-- Tabela ASSOCIATIVA (ponte entre as duas)
CREATE TABLE matriculas (
    id SERIAL PRIMARY KEY,
    aluno_id INTEGER NOT NULL,
    disciplina_id INTEGER NOT NULL,
    data_matricula DATE DEFAULT CURRENT_DATE,
    nota_final DECIMAL(4,2),
    
    FOREIGN KEY (aluno_id) REFERENCES alunos(id),
    FOREIGN KEY (disciplina_id) REFERENCES disciplinas(id),
    
    -- Evitar matrÃ­cula duplicada (mesmo aluno na mesma disciplina):
    UNIQUE (aluno_id, disciplina_id)
);

-- Inserindo dados:
INSERT INTO alunos (matricula, nome) VALUES
    ('2024001', 'Pedro Alves'),
    ('2024002', 'Julia Mendes');

INSERT INTO disciplinas (codigo, nome, carga_horaria) VALUES
    ('INF101', 'Banco de Dados', 80),
    ('INF102', 'ProgramaÃ§Ã£o Web', 60);

-- Pedro matriculado em Banco de Dados e ProgramaÃ§Ã£o Web:
INSERT INTO matriculas (aluno_id, disciplina_id) VALUES
    (1, 1),
    (1, 2);

-- Julia matriculada apenas em Banco de Dados:
INSERT INTO matriculas (aluno_id, disciplina_id) VALUES
    (2, 1);

-- Consulta: Quais disciplinas Pedro cursa?
SELECT d.nome 
FROM disciplinas d
INNER JOIN matriculas m ON d.id = m.disciplina_id
WHERE m.aluno_id = 1;


================================================================================
     PARTE 2: ON DELETE E ON UPDATE (14:45 - 15:30)
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2.1 O QUE ACONTECE AO DELETAR/ATUALIZAR REGISTRO REFERENCIADO?            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Imagine:
- Departamento "TI" (id=1) tem 10 funcionÃ¡rios
- O que acontece se deletar o departamento "TI"?
- E se alterar o id de 1 para 100?

VocÃª pode definir o comportamento com ON DELETE e ON UPDATE:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPÃ‡ÃƒO          â”‚ COMPORTAMENTO                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CASCADE        â”‚ Deleta/atualiza em cascata os filhos tambÃ©m  â”‚
â”‚ SET NULL       â”‚ Define NULL nos filhos                        â”‚
â”‚ SET DEFAULT    â”‚ Define valor DEFAULT nos filhos               â”‚
â”‚ RESTRICT       â”‚ IMPEDE se houver filhos (padrÃ£o)             â”‚
â”‚ NO ACTION      â”‚ Igual a RESTRICT                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2.2 CASCADE - PROPAGAR ALTERAÃ‡ÃƒO                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE categorias (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(50) NOT NULL
);

CREATE TABLE produtos (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(100),
    categoria_id INTEGER,
    
    FOREIGN KEY (categoria_id) 
        REFERENCES categorias(id) 
        ON DELETE CASCADE        -- Se deletar categoria, deleta produtos
        ON UPDATE CASCADE        -- Se mudar id da categoria, atualiza produtos
);

-- Teste:
INSERT INTO categorias (id, nome) VALUES (1, 'EletrÃ´nicos');
INSERT INTO produtos (nome, categoria_id) VALUES 
    ('Notebook', 1),
    ('Mouse', 1);

-- Deletar categoria:
DELETE FROM categorias WHERE id = 1;
-- Resultado: Categoria E os 2 produtos sÃ£o deletados! (CASCADE)

/*
   âš ï¸ CUIDADO COM CASCADE:
   - Pode deletar MUITOS dados sem querer
   - Use apenas quando faz sentido (ex: pedido â†’ itens do pedido)
   - Evite em relacionamentos importantes
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2.3 SET NULL - TORNAR Ã“RFÃƒO                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE gerentes (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(100)
);

CREATE TABLE equipes (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(100),
    gerente_id INTEGER,
    
    FOREIGN KEY (gerente_id) 
        REFERENCES gerentes(id) 
        ON DELETE SET NULL       -- Se deletar gerente, equipe fica sem gerente
);

-- Teste:
INSERT INTO gerentes (id, nome) VALUES (1, 'Carlos Silva');
INSERT INTO equipes (nome, gerente_id) VALUES ('Equipe A', 1);

-- Deletar gerente:
DELETE FROM gerentes WHERE id = 1;
-- Resultado: Gerente deletado, equipe.gerente_id = NULL

/*
   ğŸ’¡ QUANDO USAR SET NULL:
   - Quando o relacionamento Ã© OPCIONAL
   - Ex: FuncionÃ¡rio pode ficar sem gerente temporariamente
   - âš ï¸ A coluna FK deve aceitar NULL!
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 2.4 RESTRICT - IMPEDIR (PADRÃƒO)                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE autores (
    id SERIAL PRIMARY KEY,
    nome VARCHAR(100)
);

CREATE TABLE livros (
    id SERIAL PRIMARY KEY,
    titulo VARCHAR(200),
    autor_id INTEGER,
    
    FOREIGN KEY (autor_id) 
        REFERENCES autores(id) 
        ON DELETE RESTRICT       -- NÃ£o pode deletar se tiver livros
);

-- Teste:
INSERT INTO autores (id, nome) VALUES (1, 'Machado de Assis');
INSERT INTO livros (titulo, autor_id) VALUES ('Dom Casmurro', 1);

-- Tentar deletar autor:
-- DELETE FROM autores WHERE id = 1;
-- ERROR: update or delete violates foreign key constraint
-- DETAIL: Key is still referenced from table "livros"

-- Para deletar, precisa PRIMEIRO deletar os livros:
DELETE FROM livros WHERE autor_id = 1;
DELETE FROM autores WHERE id = 1;  -- Agora funciona!

/*
   ğŸ’¡ QUANDO USAR RESTRICT:
   - Quando nÃ£o pode deletar "pai" com "filhos"
   - ForÃ§a a limpar filhos manualmente primeiro
   - Mais seguro (evita perda acidental de dados)
   - Ã‰ o comportamento PADRÃƒO se nÃ£o especificar
*/


================================================================================
     PARTE 3: ALTER TABLE - MODIFICAR TABELAS (15:45 - 17:00)
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.1 ADICIONAR COLUNA                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Adicionar coluna simples
ALTER TABLE funcionarios 
ADD COLUMN email VARCHAR(100);

-- Adicionar com constraint
ALTER TABLE funcionarios 
ADD COLUMN telefone VARCHAR(15) UNIQUE;

-- Adicionar com DEFAULT (preenche linhas existentes)
ALTER TABLE funcionarios 
ADD COLUMN ativo BOOLEAN DEFAULT TRUE;

-- Adicionar mÃºltiplas colunas de uma vez
ALTER TABLE funcionarios 
ADD COLUMN data_admissao DATE DEFAULT CURRENT_DATE,
ADD COLUMN cargo VARCHAR(50);

/*
   ğŸ’¡ SOBRE VALORES EM LINHAS EXISTENTES:
   - Se coluna tem DEFAULT â†’ preenche com DEFAULT
   - Se coluna Ã© NULL â†’ fica NULL
   - Se coluna Ã© NOT NULL sem DEFAULT â†’ ERRO!
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.2 REMOVER COLUNA                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Remover coluna
ALTER TABLE funcionarios 
DROP COLUMN telefone;

-- âš ï¸ ISSO DELETA PERMANENTEMENTE A COLUNA E TODOS OS DADOS!

-- Se coluna Ã© FK, precisa remover a constraint primeiro:
ALTER TABLE funcionarios 
DROP CONSTRAINT fk_nome_constraint CASCADE;

-- Depois remove a coluna:
ALTER TABLE funcionarios 
DROP COLUMN departamento_id;


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.3 MODIFICAR TIPO DE COLUNA                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Mudar tipo de dados
ALTER TABLE funcionarios 
ALTER COLUMN nome TYPE VARCHAR(200);

-- Com conversÃ£o usando USING
ALTER TABLE produtos 
ALTER COLUMN preco TYPE INTEGER USING preco::INTEGER;

/*
   âš ï¸ CUIDADO:
   - Pode perder dados (ex: VARCHAR â†’ INTEGER)
   - Pode falhar se dados nÃ£o sÃ£o compatÃ­veis
   - Teste em ambiente de desenvolvimento primeiro!
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.4 ADICIONAR/REMOVER NOT NULL                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Tornar coluna obrigatÃ³ria
ALTER TABLE funcionarios 
ALTER COLUMN email SET NOT NULL;

-- âš ï¸ Falha se jÃ¡ existem NULLs! Preencha antes:
UPDATE funcionarios SET email = 'sem@email.com' WHERE email IS NULL;
ALTER TABLE funcionarios ALTER COLUMN email SET NOT NULL;

-- Permitir NULL novamente
ALTER TABLE funcionarios 
ALTER COLUMN email DROP NOT NULL;


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.5 ADICIONAR/MODIFICAR DEFAULT                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Adicionar DEFAULT
ALTER TABLE funcionarios 
ALTER COLUMN ativo SET DEFAULT TRUE;

-- Mudar DEFAULT
ALTER TABLE funcionarios 
ALTER COLUMN ativo SET DEFAULT FALSE;

-- Remover DEFAULT
ALTER TABLE funcionarios 
ALTER COLUMN ativo DROP DEFAULT;

/*
   ğŸ’¡ DEFAULT sÃ³ afeta NOVAS inserÃ§Ãµes!
   NÃ£o altera linhas que jÃ¡ existem.
*/


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.6 ADICIONAR FOREIGN KEY EM TABELA EXISTENTE                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Adicionar FK
ALTER TABLE funcionarios 
ADD CONSTRAINT fk_funcionarios_departamento 
    FOREIGN KEY (departamento_id) 
    REFERENCES departamentos(id) 
    ON DELETE RESTRICT;

-- âš ï¸ SÃ³ funciona se os valores jÃ¡ sÃ£o vÃ¡lidos!
-- Se tiver departamento_id = 99 e departamento 99 nÃ£o existe, DÃ ERRO!


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.7 REMOVER CONSTRAINT                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Remover por nome
ALTER TABLE funcionarios 
DROP CONSTRAINT fk_funcionarios_departamento;

-- Se nÃ£o sabe o nome, consulte:
SELECT constraint_name 
FROM information_schema.table_constraints 
WHERE table_name = 'funcionarios' 
  AND constraint_type = 'FOREIGN KEY';


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.8 RENOMEAR TABELA OU COLUNA                                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Renomear tabela
ALTER TABLE funcionarios RENAME TO empregados;

-- Renomear coluna
ALTER TABLE empregados RENAME COLUMN nome TO nome_completo;


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ 3.9 DROP TABLE vs TRUNCATE TABLE                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- DROP TABLE: Deleta tabela E estrutura
DROP TABLE funcionarios;
-- âš ï¸ Tabela desaparece completamente! NÃ£o tem Ctrl+Z!

-- DROP com CASCADE (deleta tabelas dependentes tambÃ©m)
DROP TABLE departamentos CASCADE;

-- TRUNCATE TABLE: Deleta DADOS mas mantÃ©m estrutura
TRUNCATE TABLE funcionarios;
-- Resultado: Tabela vazia, mas ainda existe

-- TRUNCATE com CASCADE (limpa tabelas relacionadas)
TRUNCATE TABLE departamentos CASCADE;

/*
   ğŸ“Š COMPARAÃ‡ÃƒO:
   
   DELETE FROM tabela   â†’ Deleta linha por linha (lento, pode usar WHERE)
   TRUNCATE TABLE       â†’ Deleta tudo rÃ¡pido (nÃ£o pode usar WHERE)
   DROP TABLE           â†’ Deleta tabela inteira (estrutura + dados)
*/


================================================================================
                    EXERCÃCIOS PRÃTICOS (17:00 - 17:30)
================================================================================

ğŸ’ª EXERCÃCIO 1: SISTEMA DE PEDIDOS (20 min)

Crie as tabelas com relacionamentos:

1. Tabela "clientes":
   - id (PK), nome, email (Ãºnico), telefone, ativo (padrÃ£o true)

2. Tabela "pedidos":
   - id (PK), cliente_id (FK â†’ clientes), data_pedido (padrÃ£o hoje),
     valor_total (decimal), status (padrÃ£o 'PENDENTE')
   - Use ON DELETE RESTRICT (nÃ£o pode deletar cliente com pedidos)

3. Tabela "produtos":
   - id (PK), nome, preco (decimal), estoque (inteiro)

4. Tabela "itens_pedido":
   - id (PK), pedido_id (FK â†’ pedidos), produto_id (FK â†’ produtos),
     quantidade, preco_unitario
   - Use ON DELETE CASCADE (se deletar pedido, deleta itens)


   -- Inicia uma transaÃ§Ã£o para seguranÃ§a
BEGIN;

-- 1) Tabela clientes
-- id: PK auto-increment (IDENTITY)
-- email: Ãºnico
CREATE TABLE clientes (
  id            BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  nome          VARCHAR(200)       NOT NULL,
  email         VARCHAR(255)       NOT NULL UNIQUE,
  telefone      VARCHAR(30),
  ativo         BOOLEAN            NOT NULL DEFAULT TRUE,
  criado_em     TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 3) Tabela produtos
-- preco como numeric(10,2), estoque inteiro com valor nÃ£o-negativo
CREATE TABLE produtos (
  id            BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  nome          VARCHAR(200)       NOT NULL,
  preco         NUMERIC(10,2)      NOT NULL CHECK (preco >= 0),
  estoque       INTEGER            NOT NULL DEFAULT 0 CHECK (estoque >= 0),
  criado_em     TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 2) Tabela pedidos
-- cliente_id FK -> clientes(id) com ON DELETE RESTRICT (nÃ£o permite apagar cliente com pedidos)
-- data_pedido default para a data/hora atual
-- valor_total numeric(12,2) (pode ser atualizado por aplicaÃ§Ã£o/trigger)
CREATE TABLE pedidos (
  id             BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  cliente_id     BIGINT            NOT NULL,
  data_pedido    TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  valor_total    NUMERIC(12,2)     NOT NULL DEFAULT 0 CHECK (valor_total >= 0),
  status         VARCHAR(20)       NOT NULL DEFAULT 'PENDENTE',
  criado_em      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  CONSTRAINT fk_pedidos_clientes FOREIGN KEY (cliente_id)
    REFERENCES clientes(id)
    ON DELETE RESTRICT
);

-- Opcional: restriÃ§Ã£o de valores vÃ¡lidos para status (ajuste conforme necessÃ¡rio)
ALTER TABLE pedidos
  ADD CONSTRAINT chk_pedidos_status CHECK (status IN ('PENDENTE','APROVADO','CANCELADO','ENVIADO','ENTREGUE'));

-- 4) Tabela itens_pedido
-- pedido_id FK -> pedidos(id) com ON DELETE CASCADE (se apagar pedido, apaga itens)
-- produto_id FK -> produtos(id) (aqui mantive padrÃ£o RESTRICT para evitar excluir produto usado em itens)
-- registra preÃ§o_unitario para histÃ³rico
CREATE TABLE itens_pedido (
  id             BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  pedido_id      BIGINT            NOT NULL,
  produto_id     BIGINT            NOT NULL,
  quantidade     INTEGER           NOT NULL CHECK (quantidade > 0),
  preco_unitario NUMERIC(10,2)     NOT NULL CHECK (preco_unitario >= 0),
  criado_em      TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  CONSTRAINT fk_itens_pedido_pedido FOREIGN KEY (pedido_id)
    REFERENCES pedidos(id)
    ON DELETE CASCADE,
  CONSTRAINT fk_itens_pedido_produto FOREIGN KEY (produto_id)
    REFERENCES produtos(id)
    ON DELETE RESTRICT
);

-- Ãndices Ãºteis (opcionais)
CREATE INDEX idx_pedidos_cliente_id ON pedidos(cliente_id);
CREATE INDEX idx_itens_pedido_pedido_id ON itens_pedido(pedido_id);
CREATE INDEX idx_itens_pedido_produto_id ON itens_pedido(produto_id);

COMMIT;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’ª EXERCÃCIO 2: INSERIR E TESTAR INTEGRIDADE (15 min)

a) Insira 2 clientes, 3 produtos, 1 pedido e 2 itens do pedido
b) Tente deletar um cliente que tem pedidos (deve dar erro)
c) Tente inserir item com produto_id inexistente (deve dar erro)
d) Delete um pedido e veja os itens serem deletados em CASCADE

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’ª EXERCÃCIO 3: MODIFICAR TABELAS (15 min)

Na tabela "clientes":
a) Adicione coluna "cpf" (CHAR 11, Ãºnico)
b) Adicione coluna "data_cadastro" (DATE, padrÃ£o hoje)
c) Torne o campo "email" obrigatÃ³rio (NOT NULL)
d) Adicione CHECK para email conter '@'

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’ª DESAFIO EXTRA:

Crie um sistema de blog:
- autores (id, nome, email)
- posts (id, autor_id FK, titulo, conteudo, data_publicacao)
- comentarios (id, post_id FK, autor_nome, texto, data)

Configure:
- ON DELETE SET NULL para posts.autor_id (post fica Ã³rfÃ£o)
- ON DELETE CASCADE para comentarios.post_id (deleta comentÃ¡rios junto)


================================================================================
                              RESUMO DA AULA
================================================================================

âœ… O QUE APRENDEMOS:

   FOREIGN KEY:
   â€¢ Cria relacionamentos entre tabelas
   â€¢ Garante integridade referencial
   â€¢ Sintaxes: inline, constraint separada, com nome

   RELACIONAMENTOS:
   â€¢ 1:N â†’ FK na tabela "muitos"
   â€¢ N:N â†’ Tabela associativa com 2 FKs

   ON DELETE / ON UPDATE:
   â€¢ CASCADE â†’ Propaga aÃ§Ã£o
   â€¢ SET NULL â†’ Define NULL
   â€¢ RESTRICT â†’ Impede aÃ§Ã£o (padrÃ£o)

   ALTER TABLE:
   â€¢ ADD/DROP COLUMN
   â€¢ ALTER COLUMN (tipo, NOT NULL, DEFAULT)
   â€¢ ADD/DROP CONSTRAINT
   â€¢ RENAME

   DROP vs TRUNCATE:
   â€¢ DROP â†’ Deleta estrutura
   â€¢ TRUNCATE â†’ Deleta dados, mantÃ©m estrutura

ğŸ“š TAREFA PARA CASA:
   1. ExercÃ­cios 21-30 da lista geral
   2. Criar mini-projeto com 4+ tabelas relacionadas
   3. Ler sobre normalizaÃ§Ã£o (1FN, 2FN, 3FN)

ğŸ”œ PRÃ“XIMA AULA:
   DML - ManipulaÃ§Ã£o de Dados e TransaÃ§Ãµes
   - INSERT avanÃ§ado (RETURNING, CONFLICT)
   - UPDATE com JOIN
   - DELETE com subconsulta
   - BEGIN, COMMIT, ROLLBACK

================================================================================
                            FIM DA AULA 03
================================================================================
